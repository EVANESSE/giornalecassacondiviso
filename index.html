<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa Collaborativa</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #6c757d;
            --primary-color-light: #f8f9fa;
            --primary-rgb: 108, 117, 125;
        }
        body.theme-allianz { --primary-color: #007bff; --primary-color-light: #cce5ff; --primary-rgb: 0, 123, 255; }
        body.theme-hdi { --primary-color: #28a745; --primary-color-light: #d4edda; --primary-rgb: 40, 167, 69; }
        body.theme-vittoria { --primary-color: #6f42c1; --primary-color-light: #e2d9f3; --primary-rgb: 111, 66, 193; }
        body.theme-arag { --primary-color: #ffc107; --primary-color-light: #fff3cd; --primary-rgb: 255, 193, 7; }
        body.theme-helvetia { --primary-color: #dc3545; --primary-color-light: #f8d7da; --primary-rgb: 220, 53, 69; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto; background: #fff; padding: 25px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;
        }
        h1, h2, h3 { color: var(--primary-color); }
        h1 { border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .box { padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; }

        #box-inizio-giornata {
            background-image: linear-gradient(to top right, rgba(var(--primary-rgb), 0.02), rgba(var(--primary-rgb), 0.08));
        }
        #form-movimento-fieldset .box {
            background-image: linear-gradient(to top right, #ffffff, rgba(var(--primary-rgb), 0.06));
        }
        #box-conteggio-cassa {
            background-image: linear-gradient(to top right, #ffffff, rgba(var(--primary-rgb), 0.06));
        }
        #box-riepilogo-movimenti {
            background-image: linear-gradient(to top right, #ffffff, rgba(var(--primary-rgb), 0.09));
        }
        #box-provvigioni {
             background-image: linear-gradient(to top right, #ffffff, rgba(var(--primary-rgb), 0.07));
        }
        #box-verifica-finale {
            background-image: linear-gradient(to top right, rgba(var(--primary-rgb), 0.05), rgba(var(--primary-rgb), 0.15));
        }
        
        input, select, button {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem;
        }
        button {
            background-color: var(--primary-color); color: white; border: none;
            cursor: pointer; font-weight: bold; transition: background-color 0.2s;
        }
        button.button-save { background-color: #28a745; font-size: 1.1rem; padding: 12px;}
        button:hover { filter: brightness(90%); }
        button:disabled, fieldset:disabled button { background-color: #ccc; cursor: not-allowed; }
        fieldset { border: none; padding: 0; margin: 0; }
        fieldset:disabled { opacity: 0.6; }
        .button-secondary { background-color: #6c757d; }
        .button-edit { background-color: #ffc107; color: #212529; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}
        .button-delete { background-color: #dc3545; font-size: 0.8rem; padding: 5px 8px; width: auto; margin: 2px;}

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; table-layout: fixed; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; word-wrap: break-word; }
        th { background-color: var(--primary-color-light); }
        .provvigione-editabile:hover { background-color: #fff3cd; cursor: pointer; }
        
        .riepilogo-totali, .risultato-verifica {
            font-size: 1.2rem; font-weight: bold; padding: 15px; margin-top: 15px;
            border-radius: 5px; background-color: var(--primary-color-light); border-left: 5px solid var(--primary-color);
        }
        .risultato-verifica.ok { color: #155724; background-color: #d4edda; border-left-color: #28a745; }
        .risultato-verifica.errore { color: #721c24; background-color: #f8d7da; border-left-color: #dc3545; }
        
        .decade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .decade-grid div { padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .decade-grid strong { color: var(--primary-color); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        
        #company-selector-modal .modal-overlay-background {
            background: radial-gradient(circle, #6c757d 0%, #212529 100%);
            backdrop-filter: blur(3px);
        }
        #company-selector-modal .modal-wrapper {
            display: flex; gap: 40px; align-items: flex-start;
        }
        #company-selector-modal .modal-content {
            background: linear-gradient(to bottom, #f8f9fa, #ffffff); border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 30px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #company-selector-modal .company-button {
            width: 300px; margin: 15px 0; font-weight: bold; padding: 30px 10px;
            border-bottom: 3px solid rgba(0,0,0,0.25); border-radius: 8px;
            background-image: linear-gradient(to top, rgba(0,0,0,0.2), transparent 40%);
            transition: all 0.2s ease-in-out; font-size: 1.4rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        #company-selector-modal .company-button:hover {
            transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.35); filter: brightness(1.1);
        }
        
        #utility-section {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        .utility-grid-container {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 20px; padding: 20px;
        }
        .utility-button {
            width: 150px; height: 105px;
            margin: 0; padding: 10px;
            border-radius: 15px; border: 1px solid #b0b0b0;
            background: linear-gradient(145deg, #f0f0f0, #cacaca);
            box-shadow: 7px 7px 15px #babecc, -7px -7px 15px #ffffff;
            color: #333; text-shadow: 1px 1px 1px #fff;
            font-size: 1rem; font-weight: bold;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 10px; cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .utility-button:hover {
            box-shadow: 4px 4px 10px #babecc, -4px -4px 10px #ffffff;
            transform: scale(0.98);
            color: #007bff;
        }
        .utility-button:active {
            box-shadow: inset 5px 5px 10px #babecc, inset -5px -5px 10px #ffffff;
            transform: scale(0.95);
            color: #28a745;
        }
        .utility-button i {
            color: #555; transition: color 0.2s ease-in-out;
        }
        .utility-button:hover i { color: #007bff; }
        .utility-button:active i { color: #28a745; }
        
        .backup-container {
            position: absolute; top: 30px; right: 40px;
            z-index: 1001; display: flex; gap: 10px;
        }
        .header-backup-button {
            width: auto; padding: 8px 15px; font-size: 0.9rem;
            background-color: #17a2b8; border-radius: 5px; margin-bottom: 0;
        }
        .logout-container {
            position: absolute;
            top: 30px;
            left: 40px;
            z-index: 1001;
        }
        .logout-button {
            background-color: #dc3545 !important;
        }

        #alerts-sidebar {
            position: fixed;
            left: 20px;
            top: 80px; /* Adjusted to not overlap with new logout button */
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 350px;
        }

        #alerts-sidebar .alert-box {
            width: 100%;
            max-width: 100%;
            margin-top: 0;
        }
        .alert-box {
            display: none;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-height: 40vh;
            overflow-y: auto;
        }
        .alert-box h3 { margin-top: 0; padding-bottom: 10px; }
        .alert-box ul { list-style: none; padding: 0; margin: 0; }
        .alert-box li { padding: 8px; border-bottom: 1px dotted #ccc; font-size: 1.1rem; }
        .alert-box li:last-child { border-bottom: none; }

        #riattivazioni-alert-container {
            background-color: #fff3cd; color: #856404; border: 2px solid #ffeeba;
        }
        #riattivazioni-alert-container h3 { color: #856404; border-bottom: 1px solid #856404; }
        #riattivazioni-alert-container strong { color: #6f42c1; }

        #promemoria-alert-container {
             background-color: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb;
        }
        #promemoria-alert-container h3 { color: #0c5460; border-bottom: 1px solid #0c5460; }
        #promemoria-alert-container strong { color: #007bff; }


        .modal-full { padding: 20px; align-items: flex-start; overflow-y: auto; }
        .modal-full .modal-content-full {
            width: 95%; max-width: 1800px; background: #fff;
            padding: 20px; border-radius: 8px; text-align: left; margin-top: 2vh;
        }
        .modal-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 2px solid #ccc; margin-bottom: 15px;
            flex-wrap: wrap; gap: 15px;
        }
        .modal-toolbar .filter-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .modal-toolbar .action-group { display: flex; align-items: center; gap: 10px; }
        .modal-toolbar .filter-group button, .modal-toolbar .filter-group select, .modal-toolbar .filter-group input, .modal-toolbar .action-group button {
            width: auto; margin-bottom: 0; padding: 8px;
        }
        .generic-table td[contenteditable="true"]:hover { background-color: #fff3cd; cursor: text; }
        .generic-table input, .generic-table select { padding: 4px; font-size: 0.9rem; border-radius: 3px; border: 1px solid #ccc;}
        .generic-table input[type="checkbox"] { width: auto; transform: scale(1.2); }
        .generic-table th.col-note, .generic-table td.col-note { width: 20%; }
        .generic-table th.col-date, .generic-table td.col-date { min-width: 165px; }
        .generic-table th.col-origine, .generic-table td.col-origine { width: 60px; text-align: center;}

        .riga-incassato { background-color: #d4edda !important; text-decoration: line-through; color: #555;}
        .riga-vecchio { background-color: #fff3cd; }
        .riga-critico { background-color: #f8d7da; }

        .save-notification {
            display: none; padding: 10px 15px; border-radius: 5px; text-align: center;
            font-weight: bold; margin: -10px auto 10px auto;
            opacity: 0; transition: opacity 0.5s ease-in-out;
            color: white;
        }
        .save-notification.success { background-color: #28a745; }
        .save-notification.error { background-color: #dc3545; }
        
        .app-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            padding: 10px 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; gap: 10px;
        }
        .app-header .header-group { display: flex; align-items: center; gap: 10px; }
        
        #status-indicator { font-weight: bold; padding: 5px 10px; border-radius: 5px; color: white; }
        #status-indicator.synced { background-color: #28a745; }
        #status-indicator.saving { background-color: #ffc107; color: black; }
        #status-indicator.error { background-color: #dc3545; }
        
        .col-data-mensile { display: none; }
        .col-totale-mensile { display: none; } /* Nascondi di default */

        body.vista-mensile .col-data-mensile { display: table-cell; }
        body.vista-mensile .col-totale-mensile { display: block; } /* Mostra in vista mensile */
        
        body.vista-mensile .col-impatto-cassa, body.vista-mensile .col-cassa-teorica { display: none; }
        
        #add-movimento-form label {
            font-weight: bold; margin-top: 15px;
            font-size: 1.1rem; display: block; color: #333;
        }
        #add-movimento-title { font-size: 1.8rem; color: #333; }

        #divIncassoMultiplo { border: 2px dashed var(--primary-color); padding: 15px; margin-top: 15px; border-radius: 5px; }
        #divIncassoMultiplo hr { margin: 20px 0; }
        
        .riporto-toggle-container {
            display: flex; align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .switch-label {
            font-weight: bold; color: var(--primary-color);
        }
        .switch {
            position: relative; display: inline-block;
            width: 60px; height: 34px;
        }
        .switch input {
            opacity: 0; width: 0; height: 0;
        }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute; content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider { background-color: #28a745; }
        input:not(:checked) + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        #auth-container {
            max-width: 400px; margin: 50px auto; padding: 30px;
            background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #auth-container h2 { text-align: center; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        #auth-container .form-toggle { text-align: center; margin-top: 15px; }
        #auth-container .form-toggle a { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        #auth-error { color: #dc3545; text-align: center; margin-top: 10px; font-weight: bold; }
        #user-info { font-weight: bold; color: #333; background-color: #e9ecef; padding: 8px 12px; border-radius: 5px; }
        
        .fixed-color-scheme h2,
        .fixed-color-scheme h3,
        .fixed-color-scheme th {
            color: #36454F !important;
        }
        .fixed-color-scheme h2 {
             text-shadow: 1px 1px 3px rgba(0,0,0,0.3), -1px -1px 1px rgba(255,255,255,0.7);
        }

        #print-layout {
            display: none;
        }
        
        /* Stili per il pulsante di reset singolo */
        .conteggio-riga {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 24px; /* Aggiunta colonna per il pulsante */
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        .btn-reset-single {
            width: 24px;
            height: 24px;
            padding: 0;
            margin: 0;
            font-size: 0.8rem;
            line-height: 24px;
            text-align: center;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 50%;
            cursor: pointer;
        }
        .btn-reset-single:hover {
            background-color: #f1b0b7;
        }


        @page {
            size: A4 landscape;
            margin: 20mm;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #fff;
                color: #000;
                margin: 0;
                padding: 0;
            }

            body > *:not(#print-layout) {
                display: none !important;
            }
            
            #print-layout {
                display: block !important;
            }

            .print-page {
                page-break-after: always;
                break-after: page;
            }
            .print-page:last-child {
                page-break-after: avoid;
                break-after: avoid;
            }
            
            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 2px solid #333;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
            .print-header h1, .print-header h2 {
                font-size: 1.4rem;
                margin: 0;
                color: #000 !important;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            .box, .container {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                background-image: none !important;
                padding: 15px;
            }
            
            h1, h2, h3, th, strong {
                color: #000 !important;
                text-shadow: none !important;
            }
            .riepilogo-totali {
                border-left-width: 3px;
                font-size: 1.1rem;
            }
            table {
                font-size: 0.8rem;
                width: 100%;
            }
            th, td {
                padding: 6px;
            }

            .print-page .conteggio-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 10px;
            }

            .print-page .conteggio-colonna h3 {
                font-size: 1.1rem;
                margin-bottom: 8px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 4px;
            }

            .print-page #conteggioBanconote div,
            .print-page #conteggioMonete div {
                grid-template-columns: 1fr 1.5fr 1.5fr;
                gap: 4px;
                margin-bottom: 3px;
                font-size: 0.75rem;
                align-items: center;
            }
            .print-page #conteggioBanconote div input,
            .print-page #conteggioMonete div input,
            .print-page #box-conteggio-assegni input {
                padding: 2px 4px;
                font-size: 0.75rem;
                margin-bottom: 2px;
            }
            .print-page #box-conteggio-assegni .button-delete,
            .print-page .btn-reset-single {
                display: none;
            }
            .print-page .risultato-verifica {
                margin-top: 15px;
                padding: 10px;
                font-size: 1rem;
            }
        }
        
        /* ========= BLOCCO OTTIMIZZAZIONE SMARTPHONE ========= */
        @media screen and (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            /* Schermata Selezione Compagnia */
            #company-selector-modal .backup-container {
                display: none;
            }
            #company-selector-modal .logout-container {
                top: 10px;
                left: 10px;
            }
            #alerts-sidebar {
                position: static;
                width: 100%;
                margin-bottom: 20px;
                order: -1;
                max-width: none;
            }
            /* CORREZIONE PER LO SCROLL */
            #company-selector-modal .modal-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 70px 10px 20px 10px; /* Aumentato padding top per logout button */
                width: 100%;
                height: 100%; /* Altezza 100% per definire l'area di scroll */
                overflow-y: auto; /* Attiva lo scroll verticale se il contenuto eccede */
                box-sizing: border-box; /* Include il padding nel calcolo dell'altezza */
            }
            #company-selector-modal .modal-content {
                width: 90vw;
                max-width: 450px;
            }
            #company-selector-modal .company-button {
                width: 100%;
                padding: 20px 10px;
                font-size: 1.2rem;
            }
            .utility-grid-container {
                grid-template-columns: 1fr 1fr;
                justify-items: center;
            }
            .utility-button {
                width: 120px;
                height: 95px;
                font-size: 0.9rem;
            }
            
            /* Modali e Toolbar */
            .modal-full {
                padding: 5px;
            }
            .modal-full .modal-content-full {
                width: 98vw;
                padding: 10px;
            }
            .modal-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .modal-toolbar .filter-group, .modal-toolbar .action-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            .modal-toolbar .filter-group > *, .modal-toolbar .action-group > * {
                width: 100%;
                margin-bottom: 5px;
            }

            /* Schermata Principale (Dentro la compagnia) */
            .container {
                padding: 10px;
            }
            .app-header {
                flex-direction: column;
                align-items: stretch;
            }
            .app-header .header-group {
                justify-content: space-between;
                flex-wrap: wrap;
            }
            .grid-container {
                grid-template-columns: 1fr; /* Impila le colonne */
            }

            /* VISUALIZZAZIONE A SCHEDE PER LE TABELLE SU MOBILE */
            .table-container-mobile-cards {
                overflow-x: hidden;
            }

            .table-container-mobile-cards table {
                border: 0;
            }

            .table-container-mobile-cards thead {
                display: none;
            }

            .table-container-mobile-cards tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                padding: 10px;
                background: #fff;
            }

            .table-container-mobile-cards td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                font-size: 0.95rem;
                border: none;
                border-bottom: 1px dotted #e1e1e1;
                padding: 12px 5px;
            }

            .table-container-mobile-cards td:last-child {
                border-bottom: 0;
            }
            
            .table-container-mobile-cards td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                padding-right: 15px;
                color: var(--primary-color);
            }
            
            .table-container-mobile-cards td.col-azioni {
                justify-content: center;
                padding-top: 15px;
            }
            .table-container-mobile-cards td.col-azioni::before {
                display: none;
            }
        }
    </style>
</head>
<body id="app-body">
    <input type="file" id="vecchio-backup-input" accept=".json" style="display: none;">

    <div id="auth-container">
        <h2>Gestione Cassa</h2>
        
        <div id="login-form" class="auth-form active">
            <h3>Accedi</h3>
            <form onsubmit="event.preventDefault(); loginUser();">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" required>
                <button type="submit">Login</button>
            </form>
            <div class="form-toggle">
                Non hai un account? <a onclick="toggleAuthForms()">Registrati</a>
            </div>
        </div>

        <div id="register-form" class="auth-form">
            <h3>Crea Account</h3>
            <form onsubmit="event.preventDefault(); registerUser();">
                <label for="register-username">Nome Utente:</label>
                <input type="text" id="register-username" required>
                <label for="register-email">Email:</label>
                <input type="email" id="register-email" required>
                <label for="register-password">Password:</label>
                <input type="password" id="register-password" required minlength="6">
                <button type="submit">Registrati</button>
            </form>
            <div class="form-toggle">
                Hai già un account? <a onclick="toggleAuthForms()">Accedi</a>
            </div>
        </div>
        <div id="auth-error"></div>
    </div>


    <div class="modal-overlay" id="company-selector-modal" style="display: none;">
        <div class="modal-overlay-background"></div>
        
        <div class="logout-container">
            <button class="header-backup-button logout-button" onclick="logoutUser()">Logout</button>
        </div>

        <div class="backup-container">
            <button class="header-backup-button" onclick="esportaBackup()"><i class="fa fa-download"></i> Esporta</button>
            <button class="header-backup-button" onclick="importaBackup()"><i class="fa fa-upload"></i> Importa</button>
            <button class="header-backup-button" onclick="sincronizzaDatiSecondari()" style="background-color: #17a2b8;"><i class="fas fa-sync-alt"></i> Sincronizza Dati</button>
            <button class="header-backup-button" onclick="convertiVecchioBackup()" style="background-color: #dc3545;"><i class="fas fa-magic"></i> Converti Backup</button>
        </div>

        <div class="modal-wrapper">
            <div id="alerts-sidebar">
               <div id="riattivazioni-alert-container" class="alert-box">
                    <h3><i class="fas fa-calendar-check"></i> Promemoria Riattivazioni Vittoria</h3>
                    <ul id="riattivazioni-alert-list"></ul>
               </div>
                <div id="promemoria-alert-container" class="alert-box">
                    <h3><i class="fas fa-bell"></i> Promemoria di Oggi</h3>
                    <ul id="promemoria-alert-list"></ul>
               </div>
            </div>
            <div class="modal-content fixed-color-scheme">
                <h2>Seleziona la Compagnia</h2>
                <button class="company-button" onclick="inizializzaApp('Allianz')" style="background-color:#007bff">Allianz</button>
                <button class="company-button" onclick="inizializzaApp('HDI')" style="background-color:#28a745">HDI</button>
                <button class="company-button" onclick="inizializzaApp('Vittoria')" style="background-color:#6f42c1">Vittoria</button>
                <button class="company-button" onclick="inizializzaApp('ARAG')" style="background-color:#ffc107">ARAG</button>
                <button class="company-button" onclick="inizializzaApp('Helvetia')" style="background-color:#dc3545">Helvetia</button>
            </div>
           
            <div class="modal-content fixed-color-scheme" id="utility-section">
                <h2>Altre Funzioni</h2>
                <div class="utility-grid-container">
                    <button class="utility-button" onclick="mostraTabella('anticipi')">
                        <i class="fas fa-hand-holding-usd fa-2x"></i>
                        <span>ANTICIPO</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('abbuoni')">
                         <i class="fas fa-tags fa-2x"></i>
                         <span>ABBUONI</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('bonifici_hdi_arag')">
                        <i class="fas fa-university fa-2x"></i>
                        <span>BONIFICI HDI/ARAG</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('pos_hdi_arag')">
                        <i class="far fa-credit-card fa-2x"></i>
                        <span>POS HDI/ARAG</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('bonifici_allianz')">
                        <i class="fas fa-university fa-2x"></i>
                        <span>BONIFICI ALLIANZ</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('bonifici_vittoria')">
                        <i class="fas fa-university fa-2x"></i>
                        <span>BONIFICI VITTORIA</span>
                    </button>
                     <button class="utility-button" onclick="mostraTabella('riattivazioni_vittoria')">
                        <i class="fas fa-calendar-check fa-2x"></i>
                        <span>RIATTIVAZIONI VITTORIA</span>
                    </button>
                    <button class="utility-button" onclick="mostraTabella('promemoria')">
                        <i class="fas fa-bell fa-2x"></i>
                        <span>PROMEMORIA</span>
                    </button>
                    <button class="utility-button" onclick="apriRicercaIncassi()">
                    <i class="fas fa-search fa-2x"></i>
                    <span>RICERCA INCASSI</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay modal-full" id="generic-modal" style="display:none;">
        <div class="modal-content-full fixed-color-scheme">
            <div class="modal-toolbar">
                <h2 id="generic-modal-title"></h2>
                <div class="filter-group">
                    <label>Filtra per data:</label>
                    <select id="generic-filtro-anno"></select>
                    <select id="generic-filtro-mese"></select>
                    <label id="generic-filtro-cliente-label">Filtra per:</label>
                    <input type="text" id="generic-filtro-cliente" placeholder="Nome...">
                    <button onclick="applicaFiltriTabella()">Applica Filtri</button>
                    <button class="button-secondary" onclick="resetFiltriTabella()">Resetta</button>
                </div>
                <div class="action-group">
                    <button class="button-save" onclick="apriFormAggiunta()"><i class="fa fa-plus"></i> Aggiungi Nuovo</button>
                    <button class="button-secondary" onclick="chiudiGenericModal()">Chiudi</button>
                </div>
             </div>
            <div id="generic-modal-notification" class="save-notification"></div>
            <div id="generic-table-container" class="table-container-mobile-cards">
                <table id="generic-table" class="generic-table">
                   <thead></thead>
                   <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-movimento-modal" style="display:none; z-index: 1001;">
        <div class="modal-content" style="text-align: left; width: 450px; padding: 30px;">
            <h2 id="add-movimento-title" style="text-align: center;">Aggiungi Nuovo</h2>
            <form id="add-movimento-form" onsubmit="event.preventDefault(); processaFormAggiunta();"></form>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="processaFormAggiunta()" class="button-save" style="width: 50%;">Salva</button>
                <button type="button" class="button-secondary" style="width: 50%;" onclick="document.getElementById('add-movimento-modal').style.display = 'none'">Annulla</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-container">
        <h1 id="main-title">Registro Cassa</h1>
        
        <div class="app-header">
             <div class="header-group">
                 <button onclick="tornaAllaSelezioneCompagnia()" class="button-secondary" title="Torna alla selezione"><i class="fa fa-arrow-left"></i> Indietro</button>
            </div>
            <div class="header-group">
                <label for="date-selector">Visualizza movimenti del:</label>
                <input type="date" id="date-selector" onchange="caricaGiornale(this.valueAsDate)">
            </div>
            <div class="header-group">
                <div id="user-info"></div>
                <div id="status-indicator"></div>
                <button onclick="stampaPersonalizzata()" class="button-secondary">Stampa</button>
                <button id="btn-festa" class="button-secondary" style="display: none;">Festa/Chiusura</button>
            </div>
         </div>
    
       
        <div class="box" id="box-inizio-giornata">
            <h2>1. Inizio Giornata</h2>
            <div class="riporto-toggle-container">
                <label for="riporto-mode-toggle" class="switch-label" id="riporto-mode-label">Riporto Automatico</label>
                <label class="switch">
                    <input type="checkbox" id="riporto-mode-toggle" onchange="toggleRiportoMode(this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>
            <label for="riportoIniziale"><strong>Riporto da Cassa Teorica Giorno Precedente (€):</strong></label>
            <input type="number" id="riportoIniziale" placeholder="0.00" step="0.01" onchange="aggiornaDatiGiornoCorrente({ riportoIniziale: parseFloat(this.value) || 0 })">
        </div>
    
        <div class="grid-container">
            <fieldset id="form-movimento-fieldset">
                <div class="box">
                    <h2 id="form-title">2. Registrazione Movimento</h2>
                    <form id="formMovimento" onsubmit="event.preventDefault(); processaFormMovimento();">
                        <input type="hidden" id="editingIndex" value="">
                        <input type="hidden" id="editingMovimentoId" value="">
                        <input type="hidden" id="editingMovimentoData" value="">
                        <label for="metodologia">Metodologia Incasso:</label>
                        <select id="metodologia" onchange="aggiornaCampiCondizionali()"></select>

                        <label for="dataMovimento">Data movimento</label>
                        <input type="date" id="dataMovimento" required>
                        
                        <div id="divVersamento" style="display:none;">
                            <label for="versamentoContanti">Versamento Contanti (€):</label>
                            <input type="number" id="versamentoContanti" step="0.01" placeholder="0.00">
                            <label for="versamentoAssegni">Versamento Assegni (€):</label>
                            <input type="number" id="versamentoAssegni" step="0.01" placeholder="0.00">
                        </div>

                        <div id="campi-standard">
                             <div id="divTipoPosAllianz" style="display:none;">
                                <label for="tipoPosAllianz">Tipo POS Allianz:</label>
                                <select id="tipoPosAllianz">
                                   <option value="POS Direzione">POS Direzione</option>
                                    <option value="POS Agenzia">POS Agenzia</option>
                                </select>
                            </div>
                             <div id="divTipoPosVittoria" style="display:none;">
                                <label for="tipoPosVittoria">Tipo POS Vittoria:</label>
                                <select id="tipoPosVittoria">
                                   <option value="POS Direzione">POS Direzione</option>
                                    <option value="POS Agenzia">POS Agenzia</option>
                                </select>
                            </div>
                            <div id="divTipoAnticipo" style="display:none;">
                                <label for="tipoAnticipo">Tipo Anticipo:</label>
                                <select id="tipoAnticipo" onchange="aggiornaCampiCondizionali()">
                                    <option value="Anticipo Contanti">Anticipo Contanti</option>
                                    <option value="Anticipo Assegno">Anticipo Assegno</option>
                                    <option value="Anticipo POS">Anticipo POS</option>
                                    <option value="Anticipo Bonifico">Anticipo Bonifico</option>
                                    <option value="Plafond">Plafond</option>
                                    <option value="Sospeso Cassa">Sospeso Cassa</option>
                                </select>
                            </div>
                    
                            <div id="divRientroMetodo" style="display:none;">
                                <label for="rientroMetodo">Metodo di Rientro:</label>
                                <select id="rientroMetodo" onchange="aggiornaCampiCondizionali()">
                                    <option value="Contanti">Contanti</option><option value="Assegno">Assegno</option>
                                    <option value="POS">POS</option><option value="Bonifico">Bonifico</option>
                                </select>
                            </div>
                            <div id="divNumeroAssegno" style="display:none;">
                                <label for="numeroAssegno">Numero Assegno:</label>
                                <input type="text" id="numeroAssegno" placeholder="N° Assegno">
                            </div>
                        </div>

                        <label for="nomeCliente">Nome Cliente:</label><input type="text" id="nomeCliente" required>
                        <label for="numeroPolizza">Numero Polizza:</label><input type="text" id="numeroPolizza">
                        <label for="importo" id="label-importo">Importo Titolo (€):</label><input type="number" id="importo" step="0.01" placeholder="0.00" required oninput="calcolaImportoMultiplo()">
                        
                         <div id="divIncassoMultiplo" style="display:none;">
                            <hr>
                            <h4>Parte 1</h4>
                            <label>Importo Parte 1 (€):</label>
                            <input type="number" id="importoMultiplo1" step="0.01" oninput="calcolaImportoMultiplo()">
                            <label>Metodologia Parte 1:</label>
                            <select id="metodologiaMultiplo1" onchange="aggiornaCampiCondizionaliMultiplo(1)"></select>
                            <div id="campiCondizionaliMultiplo1"></div>
                            <hr>
                            <h4>Parte 2</h4>
                            <label>Importo Parte 2 (€):</label>
                            <input type="number" id="importoMultiplo2" step="0.01" readonly>
                            <label>Metodologia Parte 2:</label>
                            <select id="metodologiaMultiplo2" onchange="aggiornaCampiCondizionaliMultiplo(2)"></select>
                            <div id="campiCondizionaliMultiplo2"></div>
                            <hr>
                         </div>

                        <div id="divProvvigioni" style="display:none;">
                            <label for="provvigioni">Provvigioni (€):</label>
                            <input type="number" id="provvigioni" step="0.01" placeholder="0.00">
                        </div>
             
                        <label for="arrotondamenti">Arrotondamenti (€):</label><input type="number" id="arrotondamenti" step="0.01" placeholder="Es. -0.02">
                        
                        <label for="abbuoni">Abbuoni (€):</label>
                        <input type="number" id="abbuoni" step="0.01" placeholder="0.00" oninput="togglePersonaAbbuono()">
                        <div id="divPersonaAbbuono" style="display:none;">
                            <label for="personaAbbuono">Persona che effettua l'abbuono:</label>
                            <input type="text" id="personaAbbuono" placeholder="Nome persona">
                        </div>
                        
                        <label for="uscite">Uscite Cassa (€):</label><input type="number" id="uscite" step="0.01" placeholder="0.00">
                        <div id="form-buttons">
                            <button type="submit">Aggiungi Movimento</button>
                        </div>
                    </form>
                </div>
            </fieldset>
            <fieldset id="box-conteggio-cassa-fieldset">
                 <div class="box" id="box-conteggio-cassa">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>3. Conteggio Fisico Cassa</h2>
                        <button type="button" onclick="azzeraConteggio()" class="button-delete" style="width: auto; font-size: 0.8rem; padding: 5px 10px; margin-bottom: 0;">Azzera</button>
                    </div>
                    <div id="conteggioBanconote"></div>
                    <div id="conteggioMonete"></div>
                    <div id="box-conteggio-assegni">
                        <h3>Assegni in Cassa</h3>
                        <div id="lista-conteggio-assegni"></div>
                        <button onclick="aggiungiCampoAssegnoConteggio()" class="button-secondary" style="width: auto; padding: 5px 10px; font-size: 0.9rem;">+ Aggiungi Assegno</button>
                    </div>
                    <div class="riepilogo-totali">Totale Contato Fisicamente: € <span id="totaleConteggioFisico">0.00</span></div>
                </div>
            </fieldset>
        </div>
    
        <div class="box" id="box-riepilogo-movimenti">
            <h2>Riepilogo Movimenti di Cassa</h2>
            <div id="main-table-container" class="table-container-mobile-cards">
                <table id="tabellaMovimenti">
                    <thead><tr>
                        <th class="col-data-mensile">Data</th>
                        <th>Cliente</th><th>Polizza</th><th>Metodo</th><th>Importo (€)</th>
                        <th class="col-provvigioni">Provv.(€)</th>
                        <th>Arroton. (€)</th>
                        <th>Abbuoni (€)</th>
                        <th>Uscite (€)</th>
                        <th class="col-impatto-cassa">Impatto (€)</th>
                        <th>Azioni</th>
                     </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- NUOVA RIGA PER TOTALE MENSILE -->
            <div class="riepilogo-totali col-totale-mensile">
                Totale Titoli Incassati nel Mese: € <span id="totaleIncassatoMese">0.00</span>
            </div>
            <div class="riepilogo-totali col-cassa-teorica">Cassa Teorica Finale (Riporto + Movimenti): € <span id="cassaTeorica">0.00</span></div>
        </div>
        
        <div class="box" id="box-provvigioni" style="display:none;">
            <h2>Riepilogo Provvigioni e Decadi (Mese Corrente)</h2>
            <div class="riepilogo-totali">
                Totale Provvigioni del Mese: € <span id="provvigioni-mese-corrente">0.00</span>
            </div>
            <div class="decade-grid">
                <div><strong>1ª Decade (1-10):</strong> € <span id="decade1-result">0.00</span></div>
                <div><strong>2ª Decade (11-20):</strong> € <span id="decade2-result">0.00</span></div>
                <div><strong>3ª Decade (21+):</strong> € <span id="decade3-result">0.00</span></div>
            </div>
        </div>
        
        <div class="box" id="box-verifica-finale">
             <h2>4. Verifica Finale</h2>
            <button onclick="verificaChiusura()" class="button-secondary">VERIFICA I CONTI</button>
            <div class="risultato-verifica" id="risultatoVerifica">In attesa di verifica...</div>
        </div>
    </div>
    
    <div id="print-layout"></div>

<script>
// ========= NUOVA CONFIGURAZIONE FIREBASE =========
    const firebaseConfig = {
      apiKey: "AIzaSyBr8TBws4pTq6nlCmbQbq8bezgNIgd63E8",
      authDomain: "giornalecassacondiviso.firebaseapp.com",
      projectId: "giornalecassacondiviso",
      storageBucket: "giornalecassacondiviso.firebasestorage.app",
      messagingSenderId: "177241129453",
      appId: "1:177241129453:web:2e4fcbe61032bb79b827e4"
    };
    // =================================================

    firebase.initializeApp(firebaseConfig);
    
    const db = firebase.firestore();
    const auth = firebase.auth();
    const statusIndicator = document.getElementById('status-indicator');

    let stato = {
        compagniaSelezionata: null,
        dataSelezionata: null,
        datiGiornoCorrente: null,
        datiUtente: null,
        movimentiVistaMensile: []
    };
    
    let unsubscribeGiornale = null;
    let unsubscribeAlerts = {};
    let unsubscribeGenericTable = null;

    const tagliBanconote = [500, 200, 100, 50, 20, 10, 5];
    const tagliMonete = [2, 1, 0.50, 0.20, 0.10, 0.05, 0.02, 0.01];

    // =================================================================
    // GESTIONE AUTENTICAZIONE
    // =================================================================
    
    auth.onAuthStateChanged(async user => {
        if (user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            stato.datiUtente = {
                uid: user.uid,
                email: user.email,
                displayName: userDoc.exists ? userDoc.data().displayName : user.email.split('@')[0]
            };
            
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('company-selector-modal').style.display = 'flex';
            document.getElementById('user-info').textContent = `Utente: ${stato.datiUtente.displayName}`;
            setupAlertListeners();
        } else {
            stato.datiUtente = null;
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('company-selector-modal').style.display = 'none';
            document.getElementById('main-container').style.display = 'none';
            Object.values(unsubscribeAlerts).forEach(unsub => unsub());
        }
    });

    function toggleAuthForms() {
        document.getElementById('login-form').classList.toggle('active');
        document.getElementById('register-form').classList.toggle('active');
        document.getElementById('auth-error').textContent = '';
    }

    async function registerUser() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorDiv = document.getElementById('auth-error');
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('users').doc(userCredential.user.uid).set({
                displayName: username
            });
            errorDiv.textContent = '';
        } catch (error) {
            errorDiv.textContent = `Errore: ${error.message}`;
        }
    }

    function loginUser() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('auth-error');

        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
                return auth.signInWithEmailAndPassword(email, password);
            })
            .catch(error => {
                errorDiv.textContent = `Errore: ${error.message}`;
            });
    }

    function logoutUser() {
        if (confirm('Sei sicuro di voler uscire?')) {
            auth.signOut().then(() => location.reload());
        }
    }
    
    // =================================================================
    // GESTIONE ALERT
    // =================================================================

    function setupAlertListeners() {
        if (unsubscribeAlerts.riattivazioni) unsubscribeAlerts.riattivazioni();
        unsubscribeAlerts.riattivazioni = db.collection('riattivazioni_vittoria').onSnapshot(snapshot => {
            const riattivazioni = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            controllaRiattivazioni(riattivazioni);
        }, error => console.error("Errore listener riattivazioni: ", error));

        if (unsubscribeAlerts.promemoria) unsubscribeAlerts.promemoria();
        unsubscribeAlerts.promemoria = db.collection('promemoria').onSnapshot(snapshot => {
            const promemoria = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            controllaPromemoria(promemoria);
        }, error => console.error("Errore listener promemoria: ", error));
    }

    function controllaRiattivazioni(riattivazioni = []) {
        const alertContainer = document.getElementById('riattivazioni-alert-container');
        const alertList = document.getElementById('riattivazioni-alert-list');
        alertList.innerHTML = '';
        const oggi = new Date();
        oggi.setHours(0, 0, 0, 0);

        const daMostrare = riattivazioni.filter(r => {
            const dataRiattivazione = r.dataRiattivazione ? new Date(r.dataRiattivazione.replace(/-/g, '/')) : null;
            return !r.riattivata && dataRiattivazione && dataRiattivazione <= oggi;
        });

        if (daMostrare.length > 0) {
            daMostrare.forEach(r => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${r.contraente || 'N/D'}</strong> - Polizza ${r.nPolizza || 'N/D'} - Targa ${r.targa || 'N/D'}.
                                 Data riattivazione: <strong>${new Date(r.dataRiattivazione.replace(/-/g, '/')).toLocaleDateString('it-IT')}</strong>`;
                alertList.appendChild(li);
            });
            alertContainer.style.display = 'block';
        } else {
            alertContainer.style.display = 'none';
        }
    }

    function controllaPromemoria(promemoria = []) {
        const alertContainer = document.getElementById('promemoria-alert-container');
        const alertList = document.getElementById('promemoria-alert-list');
        alertList.innerHTML = '';
        const oggiStr = formatDate(new Date());

        const daMostrare = promemoria.filter(p => !p.fatto && p.data === oggiStr);

        if (daMostrare.length > 0) {
            daMostrare.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${p.utente || 'N/D'}:</strong> ${p.nota || ''}`;
                alertList.appendChild(li);
            });
            alertContainer.style.display = 'block';
        } else {
            alertContainer.style.display = 'none';
        }
    }

    // =================================================================
    // LOGICA PRINCIPALE E GIORNALE CASSA
    // =================================================================

    function inizializzaApp(compagnia) {
        stato.compagniaSelezionata = compagnia;
        document.body.className = `theme-${compagnia.toLowerCase()}`;
        document.getElementById('company-selector-modal').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        
        document.getElementById('main-title').textContent = `Registro Cassa ${compagnia}`;
        const showProvvigioni = compagnia === 'HDI' || compagnia === 'Vittoria';
        document.getElementById('box-provvigioni').style.display = showProvvigioni ? 'block' : 'none';
        
        const selectMetodo = document.getElementById('metodologia');
        selectMetodo.innerHTML = `<option value="Contanti">Contanti</option><option value="Assegno">Assegno</option><option value="POS">POS</option><option value="Bonifico">Bonifico</option>`;
        selectMetodo.add(new Option('Versamento', 'Versamento'));
        
        // Aggiunta metodi di pagamento specifici per compagnia
        if (compagnia === 'Allianz') {
             selectMetodo.add(new Option('Finanziamento Allianz Bank', 'Finanziamento Allianz Bank'));
             selectMetodo.add(new Option('Pay By Link', 'Pay By Link'));
        }
        if (compagnia === 'Vittoria') {
             selectMetodo.add(new Option('Punti Vittoria', 'Punti Vittoria'));
             selectMetodo.add(new Option('Carta da APP', 'Carta da APP'));
        }
        if (compagnia === 'HDI') {
             selectMetodo.add(new Option('Pagamento Online', 'Pagamento Online'));
        }

        if (['Allianz', 'HDI', 'Vittoria'].includes(compagnia)) {
            selectMetodo.add(new Option('Incasso Multiplo', 'Incasso Multiplo'));
        }
        selectMetodo.add(new Option('Anticipo', 'Anticipo'));
        selectMetodo.add(new Option('Rientro da Anticipo', 'Rientro da Anticipo'));

        const isSimplifiedView = compagnia === 'ARAG' || compagnia === 'Helvetia';
        document.getElementById('box-inizio-giornata').style.display = isSimplifiedView ? 'none' : 'block';
        document.getElementById('box-conteggio-cassa').style.display = isSimplifiedView ? 'none' : 'block';
        document.getElementById('box-verifica-finale').style.display = isSimplifiedView ? 'none' : 'block';
        document.getElementById('btn-festa').style.display = isSimplifiedView ? 'none' : 'inline-block';

        if (isSimplifiedView) {
            document.body.classList.add('vista-mensile');
            document.querySelector('#date-selector').labels[0].textContent = "Visualizza movimenti del mese:";
        } else {
            document.body.classList.remove('vista-mensile');
            document.querySelector('#date-selector').labels[0].textContent = "Giornale del:";
        }

        document.getElementById('date-selector').valueAsDate = new Date();
    const dmEl = document.getElementById('dataMovimento');
    if (dmEl) dmEl.value = formatDate(new Date());
        caricaGiornale(new Date());
    }

    function tornaAllaSelezioneCompagnia() {
        document.getElementById('main-container').style.display = 'none';
        document.getElementById('company-selector-modal').style.display = 'flex';
        if (unsubscribeGiornale) unsubscribeGiornale();
        stato.compagniaSelezionata = null;
        stato.datiGiornoCorrente = null;
        stato.movimentiVistaMensile = [];
        document.body.className = '';
    }

    function caricaGiornale(data) {
        if (!data || !stato.compagniaSelezionata) return;
        stato.dataSelezionata = data;
    const dmEl = document.getElementById('dataMovimento');
    if (dmEl) dmEl.value = formatDate(data);
        
        if (unsubscribeGiornale) unsubscribeGiornale();

        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        
        if (isSimplifiedView) {
            stato.movimentiVistaMensile = [];
            const selectedMonth = data.getMonth();
            const selectedYear = data.getFullYear();
            
            unsubscribeGiornale = db.collection('giornaliCassa')
                .where('compagnia', '==', stato.compagniaSelezionata)
                .where('anno', '==', selectedYear)
                .where('mese', '==', selectedMonth)
                .onSnapshot(snapshot => {
                    let movimentiDaMostrare = [];
                    snapshot.forEach(doc => {
                        const movimentiDelGiorno = doc.data().movimenti || [];
                        movimentiDelGiorno.forEach((m, index) => {
                            m.dataMovimento = doc.data().dataKey;
                            m.originalIndex = index;
                            movimentiDaMostrare.push(m);
                        });
                    });
                    movimentiDaMostrare.sort((a, b) => new Date(b.dataMovimento) - new Date(a.dataMovimento));
                    stato.movimentiVistaMensile = movimentiDaMostrare;
                    aggiornaTabellaMovimenti(stato.movimentiVistaMensile);
                    aggiornaTuttiRiepiloghi();
                    annullaModifica();
                }, error => console.error("Errore vista semplificata:", error));

        } else {
            stato.datiGiornoCorrente = null;
            const dataKey = formatDate(data);
            const docId = `${stato.compagniaSelezionata}_${dataKey}`;
            
            unsubscribeGiornale = db.collection('giornaliCassa').doc(docId).onSnapshot(async doc => {
                statusIndicator.textContent = 'Sincronizzato';
                statusIndicator.className = 'synced';
                
                if (doc.exists) {
                    stato.datiGiornoCorrente = doc.data();
                    if (!stato.datiGiornoCorrente.riportoIsManual) {
                        const riportoCorretto = await calcolaRiporto(stato.dataSelezionata);
                        if (Math.abs(riportoCorretto - (stato.datiGiornoCorrente.riportoIniziale || 0)) > 0.01) {
                            await aggiornaDatiGiornoCorrente({ riportoIniziale: riportoCorretto });
                            return;
                        }
                    }
                } else {
                    const riporto = await calcolaRiporto(data);
                    stato.datiGiornoCorrente = creaNuovoGiorno(data, riporto);
                }
                renderGiornale(stato.datiGiornoCorrente);
            }, error => {
                console.error("Errore nel listener del giornale: ", error);
                statusIndicator.textContent = 'Errore Connessione';
                statusIndicator.className = 'error';
            });
        }
    }
    
    function renderGiornale(datiGiorno) {
        const inputRiporto = document.getElementById('riportoIniziale');
        const toggle = document.getElementById('riporto-mode-toggle');
        const label = document.getElementById('riporto-mode-label');

        if (datiGiorno.riportoIsManual) {
            toggle.checked = true;
            label.textContent = 'Riporto Manuale';
            inputRiporto.readOnly = false;
        } else {
            toggle.checked = false;
            label.textContent = 'Riporto Automatico';
            inputRiporto.readOnly = true;
        }
        inputRiporto.value = (datiGiorno.riportoIniziale || 0).toFixed(2);
        
        creaCampiConteggio(datiGiorno.conteggioFisico);
        const divRisultato = document.getElementById('risultatoVerifica');
        if (datiGiorno.verificaResult) {
            divRisultato.textContent = datiGiorno.verificaResult.text;
            divRisultato.className = `risultato-verifica ${datiGiorno.verificaResult.class || ''}`;
        } else {
            divRisultato.textContent = 'In attesa di verifica...';
            divRisultato.className = 'risultato-verifica';
        }

        impostaStatoGiornata(datiGiorno.isGiornoFestivo);
        aggiornaTabellaMovimenti(datiGiorno.movimenti);
        aggiornaTuttiRiepiloghi();
    }
    
    function creaNuovoGiorno(data, riporto) {
        const dataKey = formatDate(data);
        return {
            riportoIniziale: riporto,
            movimenti: [],
            conteggioFisico: {},
            cassaTeorica: riporto,
            dataKey: dataKey,
            compagnia: stato.compagniaSelezionata,
            anno: data.getFullYear(),
            mese: data.getMonth()
        };
    }
    
    async function aggiornaDatiGiornoCorrente(datiParziali, movimentiDaSincronizzare = null) {
        if (!stato.compagniaSelezionata || !stato.dataSelezionata) return;

        const dataKey = formatDate(stato.dataSelezionata);
        const docId = `${stato.compagniaSelezionata}_${dataKey}`;
        const docRef = db.collection('giornaliCassa').doc(docId);
        
        const datiDefault = {
            lastModifiedBy: stato.datiUtente.displayName,
            lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        const datiDaSalvare = { ...datiDefault, ...datiParziali };
        
        datiDaSalvare.dataKey = dataKey;
        datiDaSalvare.compagnia = stato.compagniaSelezionata;
        datiDaSalvare.anno = stato.dataSelezionata.getFullYear();
        datiDaSalvare.mese = stato.dataSelezionata.getMonth();
        
        try {
            statusIndicator.textContent = 'Salvataggio...';
            statusIndicator.className = 'saving';
            await docRef.set(datiDaSalvare, { merge: true });
            
            if (movimentiDaSincronizzare) {
                for (const mov of movimentiDaSincronizzare) {
                    await gestisciMovimentiSecondari(mov, dataKey, stato.compagniaSelezionata);
                }
            }

        } catch (error) {
            console.error("Errore durante l'aggiornamento del giorno: ", error);
            statusIndicator.textContent = 'Errore Salvataggio';
            statusIndicator.className = 'error';
        }
    }

    async function processaFormMovimento() {
    const editingIndex = document.getElementById('editingIndex').value;
    const editingMovimentoId = document.getElementById('editingMovimentoId').value;
    const editingMovimentoData = document.getElementById('editingMovimentoData').value;

    // Default = giorno selezionato in alto; modificabile solo se voluto
    const dataMovimentoEl = document.getElementById('dataMovimento');
    const targetDateKey = (dataMovimentoEl && dataMovimentoEl.value)
        ? dataMovimentoEl.value
        : formatDate(stato.dataSelezionata || new Date());

    if (!targetDateKey) {
        alert('Seleziona la data del movimento.');
        return;
    }

    const isSimplifiedView = (stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia');

    const baseMovimento = {
        createdBy: stato.datiUtente.displayName,
        createdAt: new Date().toISOString(),
        movimentoId: editingMovimentoId || `${new Date().getTime()}-${Math.random().toString(36).substring(2, 9)}`,
        dataMovimento: targetDateKey
    };

    const metodologia = document.getElementById('metodologia').value;
    let nuoviMovimenti = [];

    if (metodologia === 'Versamento') {
        const versamentoContanti = parseFloat(document.getElementById('versamentoContanti').value) || 0;
        const versamentoAssegni = parseFloat(document.getElementById('versamentoAssegni').value) || 0;

        if (versamentoContanti > 0) {
            nuoviMovimenti.push({
                ...baseMovimento,
                movimentoId: `${baseMovimento.movimentoId}-1`,
                metodologia: 'Versamento',
                nomeCliente: 'Versamento Contanti',
                uscite: versamentoContanti
            });
        }
        if (versamentoAssegni > 0) {
            nuoviMovimenti.push({
                ...baseMovimento,
                movimentoId: `${baseMovimento.movimentoId}-2`,
                metodologia: 'Versamento',
                nomeCliente: 'Versamento Assegni',
                uscite: versamentoAssegni
            });
        }
        if (nuoviMovimenti.length === 0) {
            alert('Inserisci almeno un importo di versamento.');
            return;
        }

    } else if (metodologia === 'Incasso Multiplo') {
        const common = {
            ...baseMovimento,
            nomeCliente: document.getElementById('nomeCliente').value,
            numeroPolizza: document.getElementById('numeroPolizza').value,
            provvigioni: parseFloat(document.getElementById('provvigioni').value) || 0,
            arrotondamenti: parseFloat(document.getElementById('arrotondamenti').value) || 0,
            abbuoni: parseFloat(document.getElementById('abbuoni').value) || 0,
            personaAbbuono: document.getElementById('personaAbbuono').value,
            uscite: parseFloat(document.getElementById('uscite').value) || 0
        };

        const importoTot = parseFloat(document.getElementById('importo').value) || 0;
        const importo1 = parseFloat(document.getElementById('importoMultiplo1').value) || 0;
        const importo2 = parseFloat(document.getElementById('importoMultiplo2').value) || 0;

        if (Math.abs(importoTot - (importo1 + importo2)) > 0.01) {
            alert("La somma delle parti non corrisponde all'importo totale.");
            return;
        }

        nuoviMovimenti.push({
            ...common,
            movimentoId: `${baseMovimento.movimentoId}-1`,
            isSplit: true,
            importo: importo1,
            metodologia: document.getElementById('metodologiaMultiplo1').value,
            ...leggiCampiCondizionaliMultiplo(1)
        });

        nuoviMovimenti.push({
            ...common,
            movimentoId: `${baseMovimento.movimentoId}-2`,
            isSplit: true,
            importo: importo2,
            metodologia: document.getElementById('metodologiaMultiplo2').value,
            ...leggiCampiCondizionaliMultiplo(2)
        });

    } else {
        nuoviMovimenti.push({
            ...baseMovimento,
            nomeCliente: document.getElementById('nomeCliente').value,
            numeroPolizza: document.getElementById('numeroPolizza').value,
            importo: parseFloat(document.getElementById('importo').value) || 0,
            provvigioni: parseFloat(document.getElementById('provvigioni').value) || 0,
            arrotondamenti: parseFloat(document.getElementById('arrotondamenti').value) || 0,
            abbuoni: parseFloat(document.getElementById('abbuoni').value) || 0,
            personaAbbuono: document.getElementById('personaAbbuono').value,
            uscite: parseFloat(document.getElementById('uscite').value) || 0,
            metodologia: metodologia,
            tipoPosAllianz: document.getElementById('tipoPosAllianz').value,
            tipoPosVittoria: document.getElementById('tipoPosVittoria').value,
            tipoAnticipo: document.getElementById('tipoAnticipo').value,
            rientroMetodo: document.getElementById('rientroMetodo').value,
            numeroAssegno: document.getElementById('numeroAssegno').value
        });
    }

    const movimentiDaSincronizzare = nuoviMovimenti;

    // Recupero movimento originale (se sto modificando)
    const oldMovement = (editingIndex !== "")
        ? (isSimplifiedView ? stato.movimentiVistaMensile[editingIndex] : stato.datiGiornoCorrente.movimenti[editingIndex])
        : null;

    const originalDateKey = (oldMovement && oldMovement.dataMovimento)
        ? oldMovement.dataMovimento
        : (editingMovimentoData || targetDateKey);

    const datiDefault = {
        lastModifiedBy: stato.datiUtente.displayName,
        lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const targetDocId = `${stato.compagniaSelezionata}_${targetDateKey}`;
    const targetDocRef = db.collection('giornaliCassa').doc(targetDocId);

    try {
        statusIndicator.textContent = 'Salvataggio...';
        statusIndicator.className = 'saving';

        // In modifica: rimuovo prima i secondari del vecchio movimento
        if (oldMovement) {
            await rimuoviMovimentiSecondari(oldMovement);
        }

        // Assicura esistenza doc target
        const targetSnap = await targetDocRef.get();
        if (!targetSnap.exists) {
            const targetDateObj = new Date(targetDateKey.replace(/-/g, '/'));
            const riportoTarget = isSimplifiedView ? 0 : await calcolaRiporto(targetDateObj);
            await targetDocRef.set({ ...creaNuovoGiorno(targetDateObj, riportoTarget), ...datiDefault }, { merge: true });
        }

        // MODIFICA con cambio data: sposto dal vecchio doc al nuovo doc (NO DUPLICATI)
        if (oldMovement && originalDateKey && originalDateKey !== targetDateKey) {
            const oldDocId = `${stato.compagniaSelezionata}_${originalDateKey}`;
            const oldDocRef = db.collection('giornaliCassa').doc(oldDocId);

            await db.runTransaction(async (transaction) => {
                const oldSnap = await transaction.get(oldDocRef);
                const newSnap = await transaction.get(targetDocRef);

                const oldDateObj = new Date(originalDateKey.replace(/-/g, '/'));
                const newDateObj = new Date(targetDateKey.replace(/-/g, '/'));

                const oldData = oldSnap.exists ? oldSnap.data() : creaNuovoGiorno(oldDateObj, 0);
                const newData = newSnap.exists ? newSnap.data() : creaNuovoGiorno(newDateObj, 0);

                const oldMov = [...(oldData.movimenti || [])].filter(m => m.movimentoId !== oldMovement.movimentoId);
                let newMov = [...(newData.movimenti || [])];

                // In modifica aggiorno solo il movimento principale
                const idxNew = newMov.findIndex(m => m.movimentoId === oldMovement.movimentoId);
                if (idxNew >= 0) newMov[idxNew] = nuoviMovimenti[0];
                else newMov.push(nuoviMovimenti[0]);

                transaction.set(oldDocRef, {
                    ...oldData,
                    ...datiDefault,
                    movimenti: oldMov,
                    compagnia: stato.compagniaSelezionata,
                    dataKey: originalDateKey,
                    anno: oldDateObj.getFullYear(),
                    mese: oldDateObj.getMonth()
                }, { merge: true });

                transaction.set(targetDocRef, {
                    ...newData,
                    ...datiDefault,
                    movimenti: newMov,
                    compagnia: stato.compagniaSelezionata,
                    dataKey: targetDateKey,
                    anno: newDateObj.getFullYear(),
                    mese: newDateObj.getMonth()
                }, { merge: true });
            });

        } else {
            // Inserimento oppure modifica senza cambio data: scrivo sul doc target
            await db.runTransaction(async (transaction) => {
                const snap = await transaction.get(targetDocRef);
                const targetDateObj = new Date(targetDateKey.replace(/-/g, '/'));
                const datiGiorno = snap.exists ? snap.data() : creaNuovoGiorno(targetDateObj, 0);

                let movimentiAggiornati = [...(datiGiorno.movimenti || [])];

                if (oldMovement) {
                    const idx = movimentiAggiornati.findIndex(m => m.movimentoId === oldMovement.movimentoId);
                    if (idx >= 0) movimentiAggiornati[idx] = nuoviMovimenti[0];
                    else movimentiAggiornati.push(nuoviMovimenti[0]);
                } else {
                    movimentiAggiornati.push(...nuoviMovimenti);
                }

                transaction.set(targetDocRef, {
                    ...datiGiorno,
                    ...datiDefault,
                    movimenti: movimentiAggiornati,
                    compagnia: stato.compagniaSelezionata,
                    dataKey: targetDateKey,
                    anno: targetDateObj.getFullYear(),
                    mese: targetDateObj.getMonth()
                }, { merge: true });
            });
        }

        // Rigenero secondari sul giorno destinazione
        for (const mov of movimentiDaSincronizzare) {
            await gestisciMovimentiSecondari(mov, targetDateKey, stato.compagniaSelezionata);
        }

    } catch (error) {
        console.error('Errore salvataggio movimento', error);
        statusIndicator.textContent = 'Errore Salvataggio';
        statusIndicator.className = 'error';
    }

    annullaModifica();
}

function modificaMovimento(index) {
    const isSimplifiedView = (stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia');
    const movimento = isSimplifiedView
        ? stato.movimentiVistaMensile[index]
        : stato.datiGiornoCorrente.movimenti[index];

    document.getElementById('editingIndex').value = index;
    document.getElementById('editingMovimentoId').value = movimento.movimentoId;

    // Salvo SEMPRE la data originale
    document.getElementById('editingMovimentoData').value = movimento.dataMovimento || formatDate(stato.dataSelezionata || new Date());

    document.getElementById('metodologia').value = movimento.metodologia;
    document.getElementById('tipoPosAllianz').value = movimento.tipoPosAllianz || 'POS Direzione';
    document.getElementById('tipoPosVittoria').value = movimento.tipoPosVittoria || 'POS Direzione';
    document.getElementById('tipoAnticipo').value = movimento.tipoAnticipo || 'Anticipo Contanti';
    document.getElementById('rientroMetodo').value = movimento.rientroMetodo || 'Contanti';
    document.getElementById('numeroAssegno').value = movimento.numeroAssegno || '';

    document.getElementById('nomeCliente').value = movimento.nomeCliente || '';
    document.getElementById('numeroPolizza').value = movimento.numeroPolizza || '';
    document.getElementById('importo').value = movimento.importo || '';
    document.getElementById('provvigioni').value = movimento.provvigioni || '';
    document.getElementById('arrotondamenti').value = movimento.arrotondamenti || '';
    document.getElementById('abbuoni').value = movimento.abbuoni || '';
    document.getElementById('personaAbbuono').value = movimento.personaAbbuono || '';
    document.getElementById('uscite').value = movimento.uscite || '';

    // Imposta data movimento
    const dmEl = document.getElementById('dataMovimento');
    if (dmEl) dmEl.value = movimento.dataMovimento || formatDate(stato.dataSelezionata || new Date());

    document.getElementById('form-title').textContent = 'Modifica Movimento';
    document.getElementById('form-buttons').innerHTML =
        `<button type="submit">Salva Modifiche</button>
         <button type="button" class="button-secondary" onclick="annullaModifica()">Annulla</button>`;

    aggiornaCampiCondizionali();
    togglePersonaAbbuono();
    window.scrollTo(0, 0);
}

function annullaModifica() {
    document.getElementById('editingIndex').value = '';
    document.getElementById('editingMovimentoId').value = '';
    document.getElementById('editingMovimentoData').value = '';

    document.getElementById('formMovimento').reset();

    // Default = data selettore in alto
    const ds = document.getElementById('date-selector').value;
    const dmEl = document.getElementById('dataMovimento');
    if (dmEl) dmEl.value = ds || formatDate(new Date());

    document.getElementById('form-title').textContent = '2. Registrazione Movimento';
    document.getElementById('form-buttons').innerHTML = `<button type="submit">Aggiungi Movimento</button>`;

    aggiornaCampiCondizionali();
    togglePersonaAbbuono();
}


async function cancellaMovimento(index) {
        if (!confirm('Sei sicuro di voler eliminare questo movimento?')) return;
        
        const isSimplifiedView = stato.compagniaSelezionata === 'ARAG' || stato.compagniaSelezionata === 'Helvetia';
        const movimentoCancellato = isSimplifiedView ? stato.movimentiVistaMensile[index] : stato.datiGiornoCorrente.movimenti[index];
        
        await rimuoviMovimentiSecondari(movimentoCancellato);

        if(isSimplifiedView) {
            const docId = `${stato.compagniaSelezionata}_${movimentoCancellato.dataMovimento}`;
            const docRef = db.collection('giornaliCassa').doc(docId);
            const doc = await docRef.get();
            if(doc.exists) {
                const movimentiOriginali = doc.data().movimenti || [];
                const nuoviMovimenti = movimentiOriginali.filter(m => m.movimentoId !== movimentoCancellato.movimentoId);
                await docRef.update({ movimenti: nuoviMovimenti });
            }
        } else {
            let movimentiAggiornati = [...(stato.datiGiornoCorrente.movimenti || [])];
            movimentiAggiornati.splice(index, 1);
            await aggiornaDatiGiornoCorrente({ movimenti: movimentiAggiornati });
        }
    }

    async function salvaProvvigioneModificata(input, index) {
        const nuovoValore = parseFloat(input.value) || 0;
        let movimentiAggiornati = [...(stato.datiGiornoCorrente.movimenti || [])];
        if (movimentiAggiornati[index]) {
            movimentiAggiornati[index].provvigioni = nuovoValore;
            await aggiornaDatiGiornoCorrente({ movimenti: movimentiAggiornati });
        }
    }

    async function calcolaRiporto(data) {
        const giornoPrecedenteLavorativo = getGiornoPrecedenteLavorativo(data);
        const dataKeyPrec = formatDate(giornoPrecedenteLavorativo);
        const docIdPrec = `${stato.compagniaSelezionata}_${dataKeyPrec}`;
        try {
            const docPrec = await db.collection('giornaliCassa').doc(docIdPrec).get();
            if (docPrec.exists) {
                return docPrec.data().cassaTeorica || 0;
            }
            return 0;
        } catch (error) {
            console.error("Errore nel calcolo del riporto: ", error);
            return 0;
        }
    }

    // ===============================================
    // IMPORT / EXPORT / CONVERSIONE
    // ===============================================

    async function esportaBackup() {
        alert("L'esportazione è iniziata. Potrebbe richiedere qualche istante. Clicca OK per continuare.");
        const backupData = {};
        const collectionsToBackup = [
            'giornaliCassa', 'anticipi', 'abbuoni', 'bonifici_hdi_arag',
            'pos_hdi_arag', 'bonifici_allianz', 'bonifici_vittoria',
            'riattivazioni_vittoria', 'promemoria'
        ];

        try {
            for (const collName of collectionsToBackup) {
                const snapshot = await db.collection(collName).get();
                backupData[collName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            const datiJson = JSON.stringify(backupData, null, 2);
            const blob = new Blob([datiJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_cassa_${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Backup esportato con successo!");

        } catch (error) {
            console.error("Errore durante l'esportazione del backup:", error);
            alert("Si è verificato un errore durante l'esportazione.");
        }
    }

    function importaBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const datiImportati = JSON.parse(event.target.result);
                    if (confirm("ATTENZIONE! Stai per sovrascrivere TUTTI i dati presenti nel database con quelli del file di backup. Questa operazione è IRREVERSIBILE. Sei assolutamente sicuro di voler procedere?")) {
                        alert("Importazione in corso. Non chiudere la pagina.");
                        
                        const batch = db.batch();
                        
                        for (const collName in datiImportati) {
                            if (Array.isArray(datiImportati[collName])) {
                                datiImportati[collName].forEach(item => {
                                    if(!item.id) {
                                        console.warn(`Oggetto senza ID nella collezione ${collName}, verrà saltato.`);
                                        return;
                                    }
                                    const docRef = db.collection(collName).doc(item.id);
                                    const dataToSet = { ...item };
                                    delete dataToSet.id;
                                    batch.set(docRef, dataToSet);
                                });
                            }
                        }
                        await batch.commit();
                        alert("Backup importato con successo! La pagina verrà ricaricata.");
                        location.reload();
                    }
                } catch (error) {
                    console.error("Errore durante l'importazione del backup:", error);
                    alert("Impossibile importare il backup. Il file potrebbe essere corrotto o non avere il formato corretto.");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    function convertiVecchioBackup() {
        const fileInput = document.getElementById('vecchio-backup-input');
        fileInput.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const vecchioBackup = JSON.parse(event.target.result);
                    const nuovoBackup = {
                        "giornaliCassa": [],
                        "promemoria": vecchioBackup.promemoria || [],
                        "riattivazioni_vittoria": vecchioBackup.riattivazioni_vittoria || [],
                        "anticipi": [], "abbuoni": [], "bonifici_hdi_arag": [], "pos_hdi_arag": [],
                        "bonifici_allianz": [], "bonifici_vittoria": []
                    };
                    
                    const compagnie = ['Allianz', 'HDI', 'Vittoria', 'ARAG', 'Helvetia'];
                    
                    compagnie.forEach(compagnia => {
                        const datiDiretti = vecchioBackup[compagnia] || {};
                        const datiMovimenti = (vecchioBackup.datiMovimenti || {})[compagnia] || {};
                        const registriGiornalieri = {...datiDiretti, ...datiMovimenti};
                        
                        for (const dataKey in registriGiornalieri) {
                            if (Object.prototype.hasOwnProperty.call(registriGiornalieri, dataKey)) {
                                const datiGiorno = registriGiornalieri[dataKey];
                                const docId = `${compagnia}_${dataKey}`;
                                const dateObj = new Date(dataKey.replace(/-/g, '/'));
                                
                                const nuovoDoc = {
                                    ...datiGiorno,
                                    id: docId,
                                    compagnia: compagnia,
                                    dataKey: dataKey,
                                    anno: dateObj.getFullYear(),
                                    mese: dateObj.getMonth()
                                };
                                nuovoBackup.giornaliCassa.push(nuovoDoc);
                            }
                        }
                    });

                    const datiJson = JSON.stringify(nuovoBackup, null, 2);
                    const blob = new Blob([datiJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_convertito_per_import.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert("Conversione completata! Il file 'backup_convertito_per_import.json' è stato scaricato.\nOra puoi usare la funzione 'Importa' (in alto a destra) con questo nuovo file.");

                } catch (error) {
                    console.error("Errore durante la conversione del backup:", error);
                    alert("Impossibile convertire il file. Potrebbe non essere un backup valido o essere corrotto.");
                }
            };
            reader.readAsText(file);
        };
        alert("Seleziona il tuo vecchio file di backup per la conversione.");
        fileInput.click();
    }
    
    async function sincronizzaDatiSecondari() {
        if (!confirm("ATTENZIONE: Questa operazione leggerà tutti i movimenti di cassa e rigenererà i dati delle 'Altre Funzioni' (Anticipi, Abbuoni, Bonifici, etc.).\n\nL'operazione è sicura ma potrebbe richiedere alcuni minuti.\n\nContinuare?")) {
            return;
        }

        try {
            alert("Sincronizzazione avviata. Non chiudere la pagina fino al messaggio di completamento.");
            
            const giornaliSnapshot = await db.collection('giornaliCassa').get();
            let totalMovimenti = 0;
            
            for (const doc of giornaliSnapshot.docs) {
                const datiGiorno = doc.data();
                if (datiGiorno.movimenti && Array.isArray(datiGiorno.movimenti)) {
                    for (const movimento of datiGiorno.movimenti) {
                        if (!movimento.movimentoId) {
                           movimento.movimentoId = `${new Date(datiGiorno.dataKey).getTime()}-${Math.random().toString(36).substring(2, 9)}`;
                        }
                        await gestisciMovimentiSecondari(movimento, datiGiorno.dataKey, datiGiorno.compagnia);
                        totalMovimenti++;
                    }
                }
            }
            
            alert(`Sincronizzazione completata con successo!\nSono stati processati ${totalMovimenti} movimenti.`);

        } catch (error) {
            console.error("Errore durante la sincronizzazione dei dati secondari:", error);
            alert(`Si è verificato un errore durante la sincronizzazione: ${error.message}`);
        }
    }


    // =========================================================
    // LOGICA DI SINCRONIZZAZIONE MOVIMENTI
    // =========================================================

    async function gestisciMovimentiSecondari(movimento, dataKey, compagnia) {
        if (!movimento.movimentoId) return;
        const docId = movimento.movimentoId;
        const baseData = {
            dataKey: dataKey,
            compagnia: compagnia,
            nomeCliente: movimento.nomeCliente,
            numeroPolizza: movimento.numeroPolizza,
            isAutomatic: true,
            sourceJournalDate: dataKey,
            lastModifiedBy: stato.datiUtente?.displayName || 'Sistema',
            lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (movimento.metodologia === 'Anticipo') {
            await db.collection('anticipi').doc(docId).set({ ...baseData, importo: movimento.importo, tipoAnticipo: movimento.tipoAnticipo, anticipoDi: '', note: '' }, { merge: true });
        } else {
            await db.collection('anticipi').doc(docId).delete().catch(() => {});
        }

        if ((movimento.abbuoni || 0) > 0) {
            await db.collection('abbuoni').doc(docId).set({ ...baseData, abbuoni: movimento.abbuoni, personaAbbuono: movimento.personaAbbuono, note: '' }, { merge: true });
        } else {
            await db.collection('abbuoni').doc(docId).delete().catch(() => {});
        }

        let targetCollection = null;
        if (movimento.metodologia === 'Bonifico') {
            if (compagnia === 'HDI' || compagnia === 'ARAG') targetCollection = 'bonifici_hdi_arag';
            else if (compagnia === 'Allianz') targetCollection = 'bonifici_allianz';
            else if (compagnia === 'Vittoria') targetCollection = 'bonifici_vittoria';
        } else if (movimento.metodologia === 'POS') {
            if (compagnia === 'HDI' || compagnia === 'ARAG') targetCollection = 'pos_hdi_arag';
        }
        const allCollections = ['bonifici_hdi_arag', 'bonifici_allianz', 'bonifici_vittoria', 'pos_hdi_arag'];
        for (const coll of allCollections) {
            if (coll !== targetCollection) {
                await db.collection(coll).doc(docId).delete().catch(() => {});
            }
        }
        if (targetCollection) {
            await db.collection(targetCollection).doc(docId).set({ ...baseData, importo: movimento.importo, note: '' }, { merge: true });
        }
    }

    async function rimuoviMovimentiSecondari(movimento) {
        if (!movimento || !movimento.movimentoId) return;
        const docId = movimento.movimentoId;
        const collections = ['anticipi', 'abbuoni', 'bonifici_hdi_arag', 'pos_hdi_arag', 'bonifici_allianz', 'bonifici_vittoria'];
        for (const coll of collections) {
            try {
                await db.collection(coll).doc(docId).delete();
            } catch (error) { /* Ignora errori se il documento non esiste */ }
        }
    }


    // ===============================================
    // SISTEMA GESTIONE TABELLE "ALTRE FUNZIONI"
    // ===============================================
    let datiTabellaCorrente = [];
    let configTabellaCorrente = {};
    
    const configsTabelle = {
        'anticipi': { type: 'anticipi', title: 'Gestione Anticipi', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', tipoAnticipo: 'Tipo Anticipo', anticipoDi: 'Anticipo di', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', importo: 'number', tipoAnticipo: 'text', anticipoDi: 'text', note: 'text', dataEstinzione: 'date' }, dataSource: 'anticipi', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['anticipoDi', 'note', 'dataEstinzione', 'incassato'] },
        'abbuoni': { type: 'abbuoni', title: 'Gestione Abbuoni', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', abbuoni: 'Importo Abbuono (€)', personaAbbuono: 'Effettuato da', note: 'Note', abbuonoRegolato: 'Regolato' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', abbuoni: 'number', personaAbbuono: 'text', note: 'text' }, dataSource: 'abbuoni', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['note', 'abbuonoRegolato'] },
        'bonifici_hdi_arag': { type: 'bonifici_hdi_arag', title: 'Gestione Bonifici (HDI/ARAG)', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', importo: 'number', note: 'text' }, dataSource: 'bonifici_hdi_arag', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['note'] },
        'pos_hdi_arag': { type: 'pos_hdi_arag', title: 'Gestione POS (HDI/ARAG)', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note', dataEstinzione: 'Data Estinzione', incassato: 'Incassato' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', importo: 'number', note: 'text', dataEstinzione: 'date' }, dataSource: 'pos_hdi_arag', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['note', 'dataEstinzione', 'incassato'] },
        'bonifici_allianz': { type: 'bonifici_allianz', title: 'Gestione Bonifici (Allianz)', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', importo: 'number', note: 'text' }, dataSource: 'bonifici_allianz', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['note'] },
        'bonifici_vittoria': { type: 'bonifici_vittoria', title: 'Gestione Bonifici (Vittoria)', columns: { dataKey: 'Data', compagnia: 'Compagnia', nomeCliente: 'Cliente', numeroPolizza: 'Polizza', importo: 'Importo (€)', note: 'Note' }, formFields: { dataKey: 'date', compagnia: 'text', nomeCliente: 'text', numeroPolizza: 'text', importo: 'number', note: 'text' }, dataSource: 'bonifici_vittoria', filterByDateOn: 'dataKey', searchClientOn: 'nomeCliente', editableFieldsForAutomatic: ['note'] },
        'riattivazioni_vittoria': { type: 'riattivazioni_vittoria', title: 'Gestione Riattivazioni Vittoria', columns: { contraente: 'CONTRAENTE', nPolizza: 'N° POLIZZA', targa: 'TARGA', dataSospensione: 'DATA SOSPENSIONE', dataRiattivazione: 'DATA RIATTIVAZIONE', note: 'NOTE', riattivata: 'RIATTIVATA' }, formFields: { contraente: 'text', nPolizza: 'text', targa: 'text', dataSospensione: 'date', dataRiattivazione: 'date', note: 'text' }, dataSource: 'riattivazioni_vittoria', filterByDateOn: 'dataSospensione', searchClientOn: 'contraente' },
        'promemoria': { type: 'promemoria', title: 'Gestione Promemoria', columns: { nota: 'NOTA PROMEMORIA', utente: 'UTENTE', data: 'DATA', fatto: 'FATTO' }, formFields: { data: 'date', utente: 'text', nota: 'textarea' }, dataSource: 'promemoria', filterByDateOn: 'data', searchClientOn: 'utente' }
    };
    
    function mostraTabella(tipo) {
        configTabellaCorrente = configsTabelle[tipo];
        if (!configTabellaCorrente) return;

        if (unsubscribeGenericTable) unsubscribeGenericTable();
        
        let query = db.collection(configTabellaCorrente.dataSource);

        if (tipo === 'bonifici_hdi_arag' || tipo === 'pos_hdi_arag') {
            query = query.where('compagnia', 'in', ['HDI', 'ARAG']);
        } else if (tipo === 'bonifici_allianz') {
            query = query.where('compagnia', '==', 'Allianz');
        } else if (tipo === 'bonifici_vittoria') {
            query = query.where('compagnia', '==', 'Vittoria');
        }
        
        unsubscribeGenericTable = query.onSnapshot(snapshot => {
            datiTabellaCorrente = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            applicaFiltriTabella();
        }, error => console.error(`Errore nel listener della tabella ${tipo}: `, error));

        document.getElementById('generic-modal-title').textContent = configTabellaCorrente.title;
        popolaFiltri(datiTabellaCorrente);
        document.getElementById('generic-modal').style.display = 'flex';
    }

    function chiudiGenericModal(){
        if(unsubscribeGenericTable) unsubscribeGenericTable();
        unsubscribeGenericTable = null;
        document.getElementById('generic-modal').style.display = 'none';
    }

    function popolaTabellaGenerica(dati) {
        const table = document.getElementById('generic-table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        const headerRow = thead.insertRow();
        const dateColumns = ['dataEstinzione', 'dataSospensione', 'dataRiattivazione', 'data', 'dataKey'];
        const booleanFields = ['incassato', 'riattivata', 'abbuonoRegolato', 'fatto'];
        const numericFields = ['importo', 'abbuoni'];
        const editableForAuto = configTabellaCorrente.editableFieldsForAutomatic || [];
        
        headerRow.insertCell().outerHTML = `<th class="col-origine">Origine</th>`;
        for (const key in configTabellaCorrente.columns) {
            const th = document.createElement('th');
            th.textContent = configTabellaCorrente.columns[key];
            if (key.toLowerCase().includes('note')) th.classList.add('col-note');
            if (dateColumns.includes(key)) th.classList.add('col-date');
            headerRow.appendChild(th);
        }
        headerRow.insertCell().outerHTML = '<th>Azioni</th>';

        const dateKeySort = configTabellaCorrente.filterByDateOn;
        dati.sort((a, b) => new Date(b[dateKeySort] || 0) - new Date(a[dateKeySort] || 0));

        dati.forEach((d) => {
            const riga = tbody.insertRow();
            riga.dataset.id = d.id;

            const cellOrigine = riga.insertCell();
            cellOrigine.dataset.label = 'Origine';
            cellOrigine.classList.add('col-origine');
            cellOrigine.style.verticalAlign = 'middle';
            cellOrigine.innerHTML = d.isAutomatic 
                ? `<i class="fas fa-sync-alt" title="Origine: Giornale Cassa"></i>` 
                : `<i class="fas fa-pencil-alt" title="Origine: Manuale"></i>`;

            for (const key in configTabellaCorrente.columns) {
                const cell = riga.insertCell();
                cell.dataset.property = key;
                cell.dataset.label = configTabellaCorrente.columns[key];
                let content = d[key] || '';
                const isEditable = !d.isAutomatic || editableForAuto.includes(key);

                if (dateColumns.includes(key)) cell.classList.add('col-date');
                if (key.toLowerCase().includes('note')) cell.classList.add('col-note');

                if (dateColumns.includes(key)) {
                    cell.innerHTML = `<input type="date" value="${content}" onchange="salvaModificaGenerica(this)" ${!isEditable ? 'readonly style="background-color:#eee;"' : ''}>`;
                } else if (booleanFields.includes(key)) {
                    cell.innerHTML = `<input type="checkbox" ${content ? 'checked' : ''} onchange="salvaModificaGenerica(this)" ${!isEditable ? 'disabled' : ''}>`;
                    cell.style.textAlign = 'center';
                } else {
                    cell.textContent = numericFields.includes(key) ? (parseFloat(content) || 0).toFixed(2) : content;
                    if (isEditable) {
                        cell.contentEditable = true;
                        cell.onblur = (e) => salvaModificaGenerica(e.target);
                    }
                }
            }
            
            const cellaAzioni = riga.insertCell();
            cellaAzioni.classList.add('col-azioni');
            cellaAzioni.dataset.label = 'Azioni';
            cellaAzioni.style.textAlign = 'center';
            cellaAzioni.innerHTML = `<button class="button-delete" onclick="cancellaMovimentoGenerico(this)">Elimina</button>`;
            
            aggiornaStileRiga(riga, d);
        });
    }

    async function salvaModificaGenerica(el) {
        const cell = el.closest('td');
        const riga = cell.closest('tr');
        const docId = riga.dataset.id;
        const proprieta = cell.dataset.property;
        if (!docId) return;

        let valore;
        if (el.type === 'checkbox') {
            valore = el.checked;
        } else if (el.isContentEditable) {
            valore = (proprieta === 'importo' || proprieta === 'abbuoni') ? (parseFloat(el.textContent) || 0) : el.textContent;
        } else {
            valore = el.value;
        }
        
        try {
            await db.collection(configTabellaCorrente.dataSource).doc(docId).update({
                [proprieta]: valore,
                lastModifiedBy: stato.datiUtente.displayName,
                lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            mostraNotificaTemporanea('generic-modal-notification', 'Salvataggio riuscito!', 'success');
        } catch (error) {
            console.error("Errore salvataggio modifica generica: ", error);
            mostraNotificaTemporanea('generic-modal-notification', 'Errore nel salvataggio.', 'error');
        }
    }
    
    async function cancellaMovimentoGenerico(buttonEl) {
        const riga = buttonEl.closest('tr');
        const docId = riga.dataset.id;
        if (!docId) return;

        const movimento = datiTabellaCorrente.find(d => d.id === docId);
        if (!movimento) {
            alert("Errore: impossibile trovare il movimento da eliminare.");
            return;
        }

        let confirmationMessage = 'Sei sicuro di voler eliminare definitivamente questo elemento?';
        if (movimento.isAutomatic) {
            confirmationMessage = "ATTENZIONE: Questo è un movimento automatico.\n\nEliminandolo da qui, verrà cancellato DEFINITIVAMENTE anche dal giornale di cassa originale.\n\nSei assolutamente sicuro di voler procedere?";
        }

        if (confirm(confirmationMessage)) {
            try {
                if (movimento.isAutomatic) {
                    const sourceDate = movimento.sourceJournalDate;
                    const sourceCompagnia = movimento.compagnia;
                    if (!sourceDate || !sourceCompagnia) {
                        throw new Error("Dati di origine mancanti, impossibile eliminare dal giornale principale.");
                    }

                    const journalDocId = `${sourceCompagnia}_${sourceDate}`;
                    const journalDocRef = db.collection('giornaliCassa').doc(journalDocId);
                    
                    await db.runTransaction(async (transaction) => {
                        const journalDoc = await transaction.get(journalDocRef);
                        if (journalDoc.exists) {
                            const datiGiorno = journalDoc.data();
                            const movimentiAggiornati = (datiGiorno.movimenti || []).filter(m => m.movimentoId !== docId);
                            transaction.update(journalDocRef, { movimenti: movimentiAggiornati });
                        }
                    });
                    
                    await db.collection(configTabellaCorrente.dataSource).doc(docId).delete();
                    await rimuoviMovimentiSecondari({ movimentoId: docId });


                } else {
                    await db.collection(configTabellaCorrente.dataSource).doc(docId).delete();
                }
                mostraNotificaTemporanea('generic-modal-notification', 'Elemento eliminato con successo.', 'success');
            } catch (error) {
                console.error("Errore durante l'eliminazione:", error);
                mostraNotificaTemporanea('generic-modal-notification', `Errore: ${error.message}`, 'error');
                alert(`Impossibile eliminare l'elemento: ${error.message}`);
            }
        }
    }
    
    function apriFormAggiunta() {
        const formContainer = document.getElementById('add-movimento-form');
        const config = configTabellaCorrente;
        document.getElementById('add-movimento-title').textContent = `Aggiungi a ${config.title}`;
        
        let formHtml = '';
        if (!config.formFields) {
            formHtml = '<p>Funzione di aggiunta non configurata.</p>';
        } else {
            for(const field in config.formFields) {
                const type = config.formFields[field];
                const label = config.columns[field] || field.charAt(0).toUpperCase() + field.slice(1);
                formHtml += `<label>${label}:</label>`;
                if (type === 'textarea') {
                    formHtml += `<textarea id="add-${field}" rows="4" style="width: 100%; padding: 10px;"></textarea>`;
                } else {
                    formHtml += `<input type="${type}" id="add-${field}" ${type === 'date' ? `value="${formatDate(new Date())}"` : ''} required>`;
                }
            }
        }
        formContainer.innerHTML = formHtml;
        document.getElementById('add-movimento-modal').style.display = 'flex';
    }

    async function processaFormAggiunta() {
        const config = configTabellaCorrente;
        if (!config.formFields) return;

        let nuovoElemento = {
            createdBy: stato.datiUtente.displayName,
            createdAt: new Date().toISOString(),
            isAutomatic: false
        };
        
        for(const field in config.formFields) {
            const input = document.getElementById(`add-${field}`);
            if (input) {
                nuovoElemento[field] = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
            }
        }
        
        await db.collection(config.dataSource).add(nuovoElemento);
        document.getElementById('add-movimento-modal').style.display = 'none';
    }
    
    function applicaFiltriTabella() {
        const anno = document.getElementById('generic-filtro-anno').value;
        const mese = document.getElementById('generic-filtro-mese').value;
        const clienteInput = document.getElementById('generic-filtro-cliente').value.toLowerCase();
        const dateKey = configTabellaCorrente.filterByDateOn;
        const clientKey = configTabellaCorrente.searchClientOn;

        let datiFiltrati = datiTabellaCorrente;
        if (anno !== 'tutti') datiFiltrati = datiFiltrati.filter(d => d[dateKey] && new Date(d[dateKey].replace(/-/g, '/')).getFullYear() == anno);
        if (mese !== 'tutti') datiFiltrati = datiFiltrati.filter(d => d[dateKey] && new Date(d[dateKey].replace(/-/g, '/')).getMonth() == mese);
        if (clienteInput) datiFiltrati = datiFiltrati.filter(d => d[clientKey] && String(d[clientKey]).toLowerCase().includes(clienteInput));
        
        popolaTabellaGenerica(datiFiltrati);
    }
    
    // ===============================================
    // FUNZIONI DI UTILITY
    // ===============================================

    function formatDate(date) {
        if (!date) return null;
        const d = new Date(date);
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getGiornoPrecedenteLavorativo(data) {
        let dataPrec = new Date(data);
        dataPrec.setDate(data.getDate() - 1);
        while (dataPrec.getDay() === 0 || dataPrec.getDay() === 6) {
            dataPrec.setDate(dataPrec.getDate() - 1);
        }
        return dataPrec;
    }
    
    function stampaPersonalizzata() {
        const printLayout = document.getElementById('print-layout');
        const mainTitle = document.getElementById('main-title').textContent;
        const dateValue = new Date(document.getElementById('date-selector').value).toLocaleDateString('it-IT');
        const isSimplified = ['ARAG', 'Helvetia'].includes(stato.compagniaSelezionata);
        let printHTML = '';

        const riepilogoMovimentiBox = document.getElementById('box-riepilogo-movimenti').cloneNode(true);
        riepilogoMovimentiBox.querySelectorAll('th:last-child, td:last-child').forEach(el => el.remove());
        if (isSimplified) {
            const cassaTeoricaBox = riepilogoMovimentiBox.querySelector('.riepilogo-totali.col-cassa-teorica');
            if (cassaTeoricaBox) cassaTeoricaBox.style.display = 'none';
        } else {
             const totaleMensileBox = riepilogoMovimentiBox.querySelector('.riepilogo-totali.col-totale-mensile');
            if (totaleMensileBox) totaleMensileBox.style.display = 'none';
        }
        
        printHTML += `
            <div class="print-page">
                <div class="print-header">
                    <h1>${mainTitle}</h1>
                    <h2>${dateValue}</h2>
                </div>
                ${riepilogoMovimentiBox.outerHTML}
            </div>`;

        if (!isSimplified) {
            const conteggioAssegniBoxClone = document.getElementById('box-conteggio-assegni').cloneNode(true);
            const verificaFinaleBoxClone = document.getElementById('box-verifica-finale').cloneNode(true);

            conteggioAssegniBoxClone.querySelector('button')?.remove();
            verificaFinaleBoxClone.querySelector('button')?.remove();

            const conteggioSoldiHTML = document.getElementById('conteggioBanconote').outerHTML + document.getElementById('conteggioMonete').outerHTML;
            const conteggioAssegniHTML = conteggioAssegniBoxClone.outerHTML;
            const verificaFinaleHTML = verificaFinaleBoxClone.outerHTML;

            printHTML += `
                <div class="print-page">
                    <div class="print-header">
                        <h1>Dettaglio Conteggio e Verifica</h1>
                        <h2>${dateValue}</h2>
                    </div>
                    <div class="conteggio-grid">
                        <div class="conteggio-colonna">
                            ${conteggioSoldiHTML}
                        </div>
                        <div class="conteggio-colonna">
                            ${conteggioAssegniHTML}
                        </div>
                    </div>
                    ${verificaFinaleHTML}
                </div>`;
        }

        printLayout.innerHTML = printHTML;

        setTimeout(() => {
            window.print();
        }, 250);
    }

    function aggiornaCampiCondizionali() {
        if (!stato.compagniaSelezionata) return;
        const metodologia = document.getElementById('metodologia').value;
        const isVersamento = metodologia === 'Versamento';

        const fieldsToToggle = ['nomeCliente', 'numeroPolizza', 'importo', 'arrotondamenti', 'abbuoni', 'uscite'];
        fieldsToToggle.forEach(id => {
            const el = document.getElementById(id);
            const label = document.querySelector(`label[for="${id}"]`);
            const display = isVersamento ? 'none' : 'block';
            if (el) el.style.display = display;
            if (label) label.style.display = display;
        });

        document.getElementById('divVersamento').style.display = isVersamento ? 'block' : 'none';
        document.getElementById('nomeCliente').required = !isVersamento;
        document.getElementById('importo').required = !isVersamento;

        if (isVersamento) {
            ['divIncassoMultiplo', 'divTipoPosAllianz', 'divTipoPosVittoria', 'divTipoAnticipo', 'divRientroMetodo', 'divNumeroAssegno', 'divProvvigioni', 'divPersonaAbbuono'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        } else {
            const isMultiplo = metodologia === 'Incasso Multiplo';
            document.getElementById('divIncassoMultiplo').style.display = isMultiplo ? 'block' : 'none';
            document.getElementById('campi-standard').style.display = isMultiplo ? 'none' : 'block';
            
            if (isMultiplo) {
                const opzioniBase = Array.from(document.getElementById('metodologia').options)
                                        .filter(opt => !['Incasso Multiplo', 'Versamento'].includes(opt.value))
                                        .map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
                document.getElementById('metodologiaMultiplo1').innerHTML = opzioniBase;
                document.getElementById('metodologiaMultiplo2').innerHTML = opzioniBase;
                aggiornaCampiCondizionaliMultiplo(1);
                aggiornaCampiCondizionaliMultiplo(2);
                calcolaImportoMultiplo();
                return;
            }

            const compagnia = stato.compagniaSelezionata;
            const rientroMetodo = document.getElementById('rientroMetodo').value;
            const tipoAnticipo = document.getElementById('tipoAnticipo').value;
            const showProvvigioni = (compagnia === 'HDI' || compagnia === 'Vittoria') && metodologia !== 'Rientro da Anticipo';
            const showRientro = metodologia === 'Rientro da Anticipo';
            const showAssegno = metodologia === 'Assegno' || (showRientro && rientroMetodo === 'Assegno') || (metodologia === 'Anticipo' && tipoAnticipo === 'Anticipo Assegno');
            const showTipoAnticipo = metodologia === 'Anticipo';
            const showTipoPosAllianz = metodologia === 'POS' && compagnia === 'Allianz';
            const showTipoPosVittoria = metodologia === 'POS' && compagnia === 'Vittoria';
            
            document.getElementById('divProvvigioni').style.display = showProvvigioni ? 'block' : 'none';
            document.getElementById('divRientroMetodo').style.display = showRientro ? 'block' : 'none';
            document.getElementById('divNumeroAssegno').style.display = showAssegno ? 'block' : 'none';
            document.getElementById('divTipoAnticipo').style.display = showTipoAnticipo ? 'block' : 'none';
            document.getElementById('divTipoPosAllianz').style.display = showTipoPosAllianz ? 'block' : 'none';
            document.getElementById('divTipoPosVittoria').style.display = showTipoPosVittoria ? 'block' : 'none';
            
            if (!showProvvigioni) document.getElementById('provvigioni').value = '';
            if (!showAssegno) document.getElementById('numeroAssegno').value = '';
        }
    }

    function togglePersonaAbbuono() {
        const abbuoniVal = parseFloat(document.getElementById('abbuoni').value) || 0;
        document.getElementById('divPersonaAbbuono').style.display = abbuoniVal > 0 ? 'block' : 'none';
        if (abbuoniVal <= 0) document.getElementById('personaAbbuono').value = '';
    }

    function calcolaImportoMultiplo() {
        const importoTot = parseFloat(document.getElementById('importo').value) || 0;
        const importo1 = parseFloat(document.getElementById('importoMultiplo1').value) || 0;
        document.getElementById('importoMultiplo2').value = (importoTot - importo1).toFixed(2);
    }
    
    function aggiornaCampiCondizionaliMultiplo(partNumber) {
        const metodologia = document.getElementById(`metodologiaMultiplo${partNumber}`).value;
        const container = document.getElementById(`campiCondizionaliMultiplo${partNumber}`);
        let html = '';
        if (metodologia === 'Assegno') {
            html = `<label>Numero Assegno:</label><input type="text" id="numeroAssegno_multiplo${partNumber}">`;
        } else if (metodologia === 'POS' && stato.compagniaSelezionata === 'Allianz') {
            html = `<label>Tipo POS:</label><select id="tipoPosAllianz_multiplo${partNumber}"><option>POS Direzione</option><option>POS Agenzia</option></select>`;
        } else if (metodologia === 'POS' && stato.compagniaSelezionata === 'Vittoria') {
            html = `<label>Tipo POS:</label><select id="tipoPosVittoria_multiplo${partNumber}"><option>POS Direzione</option><option>POS Agenzia</option></select>`;
        }
        container.innerHTML = html;
    }
    
    function leggiCampiCondizionaliMultiplo(partNumber) {
        const dati = {};
        const elAssegno = document.getElementById(`numeroAssegno_multiplo${partNumber}`);
        const elPosAllianz = document.getElementById(`tipoPosAllianz_multiplo${partNumber}`);
        const elPosVittoria = document.getElementById(`tipoPosVittoria_multiplo${partNumber}`);
        if (elAssegno) dati.numeroAssegno = elAssegno.value;
        if (elPosAllianz) dati.tipoPosAllianz = elPosAllianz.value;
        if (elPosVittoria) dati.tipoPosVittoria = elPosVittoria.value;
        return dati;
    }

    function aggiornaTabellaMovimenti(movimenti = []) {
        const tbody = document.getElementById('tabellaMovimenti').querySelector('tbody');
        tbody.innerHTML = '';
        const showProvvigioni = stato.compagniaSelezionata === 'HDI' || stato.compagniaSelezionata === 'Vittoria';

        const createCell = (riga, label, content, className = '') => {
            const cell = riga.insertCell();
            cell.dataset.label = label;
            cell.className = className;
            cell.innerHTML = content;
            return cell;
        };
        
        (movimenti || []).forEach((m, index) => {
            const dataKeyOriginale = m.dataMovimento || formatDate(stato.dataSelezionata);
            let impattoCassa = 0;
            const isCashBased = ['Contanti', 'Assegno'].includes(m.metodologia) || (m.metodologia === 'Rientro da Anticipo' && ['Contanti', 'Assegno'].includes(m.rientroMetodo));
            if (isCashBased) impattoCassa = (m.importo || 0) + (m.arrotondamenti || 0) - (m.abbuoni || 0);
            impattoCassa -= (m.uscite || 0);

            let metodoDisplay = m.metodologia;
            if (m.metodologia === 'Anticipo') metodoDisplay = `Anticipo (${m.tipoAnticipo || ''})`;
            else if (m.metodologia === 'POS' && stato.compagniaSelezionata === 'Allianz') metodoDisplay = `POS (${m.tipoPosAllianz || ''})`;
            else if (m.metodologia === 'POS' && stato.compagniaSelezionata === 'Vittoria') metodoDisplay = `POS (${m.tipoPosVittoria || ''})`;
            else if (m.metodologia === 'Assegno' || (m.metodologia === 'Rientro da Anticipo' && m.rientroMetodo === 'Assegno')) metodoDisplay += ` ${m.numeroAssegno || ''}`;
            else if (m.metodologia === 'Rientro da Anticipo') metodoDisplay += ` (${m.rientroMetodo || ''})`;
            
            const riga = tbody.insertRow();
            
            createCell(riga, 'Data', new Date(dataKeyOriginale.replace(/-/g, '/')).toLocaleDateString('it-IT'), 'col-data-mensile');
            createCell(riga, 'Cliente', m.nomeCliente || '');
            createCell(riga, 'Polizza', m.numeroPolizza || '');
            createCell(riga, 'Metodo', metodoDisplay || '');
            createCell(riga, 'Importo (€)', (m.importo || 0).toFixed(2));
            const cellProvv = createCell(riga, 'Provv.(€)', (m.provvigioni || 0).toFixed(2), 'col-provvigioni provvigione-editabile');
            cellProvv.onclick = () => rendiProvvigioneEditabile(cellProvv, index);
            createCell(riga, 'Arroton. (€)', (m.arrotondamenti || 0).toFixed(2));
            createCell(riga, 'Abbuoni (€)', (m.abbuoni || 0).toFixed(2));
            createCell(riga, 'Uscite (€)', (m.uscite || 0).toFixed(2));
            createCell(riga, 'Impatto (€)', `<strong>${impattoCassa.toFixed(2)}</strong>`, 'col-impatto-cassa');
            createCell(riga, 'Azioni', `
                <button class="button-edit" onclick="modificaMovimento(${index})" ${m.isSplit || m.metodologia === 'Versamento' ? 'disabled' : ''}>Modifica</button>
                <button class="button-delete" onclick="cancellaMovimento(${index})">Elimina</button>`, 'col-azioni');
        });
        document.querySelectorAll('.col-provvigioni').forEach(el => el.style.display = showProvvigioni ? '' : 'none');
    }

    function rendiProvvigioneEditabile(cell, index) {
        if (cell.querySelector('input')) return;
        const valoreCorrente = cell.textContent;
        cell.innerHTML = `<input type="number" step="0.01" value="${valoreCorrente}" style="width: 80px;" onblur="salvaProvvigioneModificata(this, ${index})" onkeydown="if(event.key === 'Enter') this.blur()"/>`;
        cell.querySelector('input').focus();
    }
    
    function aggiornaTuttiRiepiloghi() {
        if (!stato.compagniaSelezionata) return;
        
        if (document.body.classList.contains('vista-mensile')) {
            // Calcola il totale del mese per ARAG/Helvetia
            calcolaTotaleIncassatoMese();
        } else {
            // Logica standard per le altre compagnie
            calcolaCassaTeorica();
            calcolaConteggioFisico();
        }

        if (stato.compagniaSelezionata === 'HDI' || stato.compagniaSelezionata === 'Vittoria') {
            aggiornaRiepilogoProvvigioni();
        }
    }
    
    async function aggiornaRiepilogoProvvigioni() {
        if (!stato.dataSelezionata) return;
        const mese = stato.dataSelezionata.getMonth();
        const anno = stato.dataSelezionata.getFullYear();
        let totaleProvvigioniMese = 0;
        const decadi = { 1: 0, 2: 0, 3: 0 };

        const snapshot = await db.collection('giornaliCassa')
            .where('compagnia', '==', stato.compagniaSelezionata)
            .where('anno', '==', anno).where('mese', '==', mese).get();
            
        snapshot.forEach(doc => {
            (doc.data().movimenti || []).forEach(m => {
                const giorno = new Date(doc.data().dataKey.replace(/-/g, '/')).getDate();
                totaleProvvigioniMese += (m.provvigioni || 0);
                if (m.metodologia !== 'Rientro da Anticipo') {
                    const decadeNum = giorno <= 10 ? 1 : (giorno <= 20 ? 2 : 3);
                    decadi[decadeNum] += (m.importo || 0) - (m.provvigioni || 0);
                }
            });
        });

        document.getElementById('provvigioni-mese-corrente').textContent = totaleProvvigioniMese.toFixed(2);
        document.getElementById('decade1-result').textContent = decadi[1].toFixed(2);
        document.getElementById('decade2-result').textContent = decadi[2].toFixed(2);
        document.getElementById('decade3-result').textContent = decadi[3].toFixed(2);
    }
    
    function calcolaCassaTeorica() {
        const riporto = parseFloat(document.getElementById('riportoIniziale').value) || 0;
        if (!stato.datiGiornoCorrente) {
            document.getElementById('cassaTeorica').textContent = riporto.toFixed(2);
            return riporto;
        }
        const movimenti = (stato.datiGiornoCorrente.movimenti || []);
        const totaleMovimentiCassa = movimenti.reduce((acc, m) => {
            const isCashBased = ['Contanti', 'Assegno'].includes(m.metodologia) || (m.metodologia === 'Rientro da Anticipo' && ['Contanti', 'Assegno'].includes(m.rientroMetodo));
            let impatto = 0;
            if (isCashBased) impatto = (m.importo || 0) + (m.arrotondamenti || 0) - (m.abbuoni || 0);
            return acc + impatto - (m.uscite || 0);
        }, 0);
        const cassaTeorica = riporto + totaleMovimentiCassa;
        if(stato.datiGiornoCorrente) stato.datiGiornoCorrente.cassaTeorica = cassaTeorica;
        document.getElementById('cassaTeorica').textContent = cassaTeorica.toFixed(2);
        return cassaTeorica;
    }
    
    function calcolaTotaleIncassatoMese() {
        if (!stato.movimentiVistaMensile || stato.movimentiVistaMensile.length === 0) {
            document.getElementById('totaleIncassatoMese').textContent = '0.00';
            return;
        }
        
        const totale = stato.movimentiVistaMensile.reduce((acc, m) => {
            return acc + (m.importo || 0);
        }, 0);
        
        document.getElementById('totaleIncassatoMese').textContent = totale.toFixed(2);
    }
    
    function calcolaConteggioFisico() {
        let totale = 0;
        document.querySelectorAll('#conteggioBanconote input, #conteggioMonete input').forEach(input => {
            const subtotale = (parseFloat(input.dataset.valore) * (parseInt(input.value) || 0));
            totale += subtotale;
            document.getElementById(`subtotale-${input.dataset.valore.replace('.', '_')}`).textContent = `€ ${subtotale.toFixed(2)}`;
        });
        document.querySelectorAll('.conteggio-assegno').forEach(input => {
            totale += parseFloat(input.value) || 0;
        });
        document.getElementById('totaleConteggioFisico').textContent = totale.toFixed(2);
        return totale;
    }

    function raccogliDatiConteggio() {
        const conteggio = { banconote: {}, monete: {}, assegni: [] };
        document.querySelectorAll('#conteggioBanconote input, #conteggioMonete input').forEach(input => {
            if (input.value && parseInt(input.value) > 0) {
                conteggio[input.dataset.tipo][input.dataset.valore] = parseInt(input.value);
            }
        });
        document.querySelectorAll('.conteggio-assegno').forEach(input => {
            if (input.value && parseFloat(input.value) > 0) {
                conteggio.assegni.push(parseFloat(input.value));
            }
        });
        return conteggio;
    }
    
    function creaCampiConteggio(datiConteggio = {}) {
        const divBanconote = document.getElementById('conteggioBanconote');
        const divMonete = document.getElementById('conteggioMonete');
        divBanconote.innerHTML = '<h3>Banconote</h3>';
        divMonete.innerHTML = '<h3>Monete</h3>';
        [...tagliBanconote, ...tagliMonete].forEach(taglio => {
            const tipo = taglio >= 5 ? 'banconote' : 'monete';
            const div = tipo === 'banconote' ? divBanconote : divMonete;
            const valoreSalvato = datiConteggio?.[tipo]?.[taglio] || '';
            const idTaglio = taglio.toString().replace('.', '_');
            const inputId = `input-conteggio-${idTaglio}`;
            
            const riga = document.createElement('div');
            riga.className = 'conteggio-riga';
            riga.innerHTML = `
                <label for="${inputId}">€ ${taglio.toFixed(2)}</label>
                <input type="number" id="${inputId}" onblur="aggiornaDatiGiornoCorrente({ conteggioFisico: raccogliDatiConteggio() })" data-valore="${taglio}" data-tipo="${tipo}" value="${valoreSalvato}">
                <span id="subtotale-${idTaglio}">€ 0.00</span>
                <button class="btn-reset-single" onclick="azzeraCampoSingolo('${inputId}')" title="Azzera riga">×</button>
            `;
            div.appendChild(riga);
        });
        const divAssegni = document.getElementById('lista-conteggio-assegni');
        divAssegni.innerHTML = '';
        (datiConteggio?.assegni || []).forEach(importo => aggiungiCampoAssegnoConteggio(importo));
        calcolaConteggioFisico();
    }
    
    function azzeraCampoSingolo(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            // Simula l'evento onblur per salvare l'aggiornamento
            const event = new Event('blur');
            input.dispatchEvent(event);
        }
    }


    function aggiungiCampoAssegnoConteggio(importo = '') {
        const divAssegni = document.getElementById('lista-conteggio-assegni');
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
        div.innerHTML = `
            <input type="number" step="0.01" class="conteggio-assegno" placeholder="Importo" value="${importo}" onblur="aggiornaDatiGiornoCorrente({ conteggioFisico: raccogliDatiConteggio() })">
            <button type="button" class="button-delete" style="width:auto;" onclick="this.parentElement.remove(); aggiornaDatiGiornoCorrente({ conteggioFisico: raccogliDatiConteggio() });">X</button>`;
        divAssegni.appendChild(div);
    }

    function azzeraConteggio() {
        if (confirm('Sei sicuro di voler azzerare tutto il conteggio fisico?')) {
            document.querySelectorAll('#box-conteggio-cassa input[type="number"]').forEach(input => {
                input.value = '';
            });
            document.getElementById('lista-conteggio-assegni').innerHTML = '';
            aggiornaDatiGiornoCorrente({ conteggioFisico: {} });
        }
    }
    
    async function verificaChiusura() {
        const teorica = calcolaCassaTeorica();
        const fisica = calcolaConteggioFisico();
        const differenza = fisica - teorica;
        let result = {};
        if (Math.abs(differenza) < 0.01) {
            result = { text: `✅ I CONTI TORNANO! Differenza: € 0.00`, class: 'ok' };
        } else {
            result = { text: `❌ ATTENZIONE! Differenza di cassa: € ${differenza.toFixed(2)}`, class: 'errore' };
        }
        await aggiornaDatiGiornoCorrente({ cassaTeorica: teorica, verificaResult: result });
    }
    
    async function toggleRiportoMode(isManual) {
        document.getElementById('riportoIniziale').readOnly = !isManual;
        document.getElementById('riporto-mode-label').textContent = isManual ? 'Riporto Manuale' : 'Riporto Automatico';
        const update = { riportoIsManual: isManual };
        if (!isManual) {
            update.riportoIniziale = await calcolaRiporto(stato.dataSelezionata);
        }
        await aggiornaDatiGiornoCorrente(update);
    }
    
    function impostaStatoGiornata(isFestivo) {
        document.getElementById('form-movimento-fieldset').disabled = !!isFestivo;
        document.getElementById('box-conteggio-cassa-fieldset').disabled = !!isFestivo;
        const btn = document.getElementById('btn-festa');
        btn.textContent = isFestivo ? 'Riattiva Giorno' : 'Festa/Chiusura';
        btn.onclick = isFestivo ? annullaChiusuraFestiva : gestisciChiusuraFestiva;
        btn.style.backgroundColor = isFestivo ? '#28a745' : '#6c757d';
    }

    async function gestisciChiusuraFestiva() {
        if (confirm("Sei sicuro di voler impostare questo giorno come festivo?")) {
            const riporto = stato.datiGiornoCorrente.riportoIniziale;
            await aggiornaDatiGiornoCorrente({ isGiornoFestivo: true, cassaTeorica: riporto });
        }
    }
    
    async function annullaChiusuraFestiva() {
        if (confirm("Vuoi riattivare questo giorno per l'inserimento?")) {
            await aggiornaDatiGiornoCorrente({ isGiornoFestivo: false });
        }
    }
    
    function resetFiltriTabella() {
        document.getElementById('generic-filtro-anno').value = 'tutti';
        document.getElementById('generic-filtro-mese').value = 'tutti';
        document.getElementById('generic-filtro-cliente').value = '';
        applicaFiltriTabella();
    }
    
    function popolaFiltri() {
        const annoSelect = document.getElementById('generic-filtro-anno');
        const meseSelect = document.getElementById('generic-filtro-mese');
        const dateKey = configTabellaCorrente.filterByDateOn;
        const years = new Set(datiTabellaCorrente.map(d => d[dateKey] ? new Date(d[dateKey].replace(/-/g, '/')).getFullYear() : null).filter(y => y));
        annoSelect.innerHTML = '<option value="tutti">Tutti</option>';
        Array.from(years).sort((a,b)=>b-a).forEach(y => annoSelect.innerHTML += `<option value="${y}">${y}</option>`);
        meseSelect.innerHTML = '<option value="tutti">Tutti</option>';
        ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"].forEach((m, i) => meseSelect.innerHTML += `<option value="${i}">${m}</option>`);
        resetFiltriTabella();
    }
    
    function aggiornaStileRiga(riga, movimento) {
        if(configTabellaCorrente.disableRowColoring) return;
        riga.className = '';
        const dateKey = configTabellaCorrente.dataSource === 'anticipi' ? 'dataKey' : configTabellaCorrente.filterByDateOn;
        if (!movimento || !movimento[dateKey]) return;

        if (movimento.incassato || movimento.abbuonoRegolato || movimento.riattivata || movimento.fatto) {
            riga.classList.add('riga-incassato');
        } else {
            const dataMovimento = new Date(movimento[dateKey].replace(/-/g, '/'));
            const diffGiorni = Math.floor((new Date() - dataMovimento) / (1000 * 60 * 60 * 24));
            if (diffGiorni > 30) riga.classList.add('riga-critico');
            else if (diffGiorni > 15) riga.classList.add('riga-vecchio');
        }
    }
    
    function mostraNotificaTemporanea(elementId, message, type) {
        const notification = document.getElementById(elementId);
        notification.textContent = message;
        notification.className = `save-notification ${type}`;
        notification.style.display = 'block';
        notification.style.opacity = '1';
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => { notification.style.display = 'none'; }, 500);
        }, 2000);
    }

</script>

<div class="modal-overlay modal-full" id="ricerca-incassi-modal" style="display:none;">
  <div class="modal-content-full fixed-color-scheme">
    <div class="modal-toolbar">
      <h2>Ricerca Incassi</h2>
      <div class="filter-group">
        <label>Inserisci nominativo (obbligatorio)</label>
        <input type="text" id="ricerca-nominativo" required placeholder="Nominativo" style="width:250px;">
        <label>Mese</label>
        <select id="ricerca-mese">
          <option value="">Tutti</option>
          <option value="0">Gennaio</option>
          <option value="1">Febbraio</option>
          <option value="2">Marzo</option>
          <option value="3">Aprile</option>
          <option value="4">Maggio</option>
          <option value="5">Giugno</option>
          <option value="6">Luglio</option>
          <option value="7">Agosto</option>
          <option value="8">Settembre</option>
          <option value="9">Ottobre</option>
          <option value="10">Novembre</option>
          <option value="11">Dicembre</option>
        </select>
        <label>Anno</label>
        <select id="ricerca-anno"></select>
        <label>Compagnia</label>
        <select id="ricerca-compagnia">
          <option value="">Tutte</option>
          <option value="Allianz">Allianz</option>
          <option value="HDI">HDI</option>
          <option value="Vittoria">Vittoria</option>
          <option value="ARAG">ARAG</option>
          <option value="Helvetia">Helvetia</option>
        </select>
        <button onclick="eseguiRicercaIncassi()">Cerca</button>
        <button class="button-secondary" onclick="chiudiRicercaIncassi()">Chiudi</button>
      </div>
    </div>
    <div id="ricerca-incassi-risultati"></div>
  </div>
</div>
<script>
  // Popola dinamicamente gli anni disponibili (puoi migliorarlo in base ai dati effettivi)
  window.onload = function() {
    var selectAnno = document.getElementById('ricerca-anno');
    if (selectAnno) {
      var annoCorrente = new Date().getFullYear();
      selectAnno.innerHTML = '<option value="">Tutti</option>';
      for (let i = annoCorrente; i >= annoCorrente - 8; i--) {
        selectAnno.innerHTML += '<option value="' + i + '">' + i + '</option>';
      }
    }
  };

  function apriRicercaIncassi() {
      document.getElementById('ricerca-incassi-modal').style.display = 'flex';
  }

  function chiudiRicercaIncassi() {
      document.getElementById('ricerca-incassi-modal').style.display = 'none';
      document.getElementById('ricerca-incassi-risultati').innerHTML = '';
  }

  async function eseguiRicercaIncassi() {
      const nominativo = document.getElementById('ricerca-nominativo').value.trim();
      if (!nominativo) {
          alert('Inserisci almeno il nominativo.');
          return;
      }
      const mese = document.getElementById('ricerca-mese').value;
      const anno = document.getElementById('ricerca-anno').value;
      const compagnia = document.getElementById('ricerca-compagnia').value;
      const risultatiContainer = document.getElementById('ricerca-incassi-risultati');
      risultatiContainer.innerHTML = 'Ricerca in corso...';

      // Query Firestore su tutte le compagnie di giornaliCassa e filtra i movimenti
      let query = db.collection('giornaliCassa');
      if (compagnia) query = query.where('compagnia', '==', compagnia);
      if (anno) query = query.where('anno', '==', parseInt(anno));
      if (mese) query = query.where('mese', '==', parseInt(mese));

      query.get().then(snapshot => {
        let risultati = [];
        snapshot.forEach(doc => {
          const dati = doc.data();
          (dati.movimenti||[]).forEach(mov => {
            if (mov.nomeCliente && mov.nomeCliente.toLowerCase().includes(nominativo.toLowerCase())) {
              risultati.push({...mov, compagnia: dati.compagnia, data: dati.dataKey});
            }
          });
        });
        if (risultati.length === 0) {
            risultatiContainer.innerHTML = "<p>Nessun risultato trovato.</p>";
        } else {
            let html = '<table class="generic-table"><thead><tr>';
            html += '<th>Data</th><th>Compagnia</th><th>Cliente</th><th>Polizza</th><th>Importo</th><th>Metodo</th></tr></thead><tbody>';
            risultati.forEach(r => {
                html += `<tr>
                  <td>${new Date(r.data.replace(/-/g, '/')).toLocaleDateString('it-IT')}</td>
                  <td>${r.compagnia||'-'}</td>
                  <td>${r.nomeCliente||'-'}</td>
                  <td>${r.numeroPolizza||'-'}</td>
                  <td>${(r.importo ?? 0).toFixed(2)}</td>
                  <td>${r.metodologia||'-'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            risultatiContainer.innerHTML = html;
        }
      }).catch(e => {
        risultatiContainer.innerHTML = 'Errore nella ricerca. ' + e;
      });
  }
</script>
</body>
</html>
